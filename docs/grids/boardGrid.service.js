"use strict";

angular.module("grids").service("BoardGridService", function () {

	var emptyBoard = true;

	var numberStack = [];

	var currentNumber = null;
	var currentOperation = null;
	var currentOperationResult = null;

	var standByOp = null;
	var standBy = false;
	var standByNum = null;

	var decimalCreated = false;

	var inputDirty = false;

	if (emptyBoard) {

		currentNumber = "0";
	}

	var isInt = function isInt(num) {

		return num % 1 === 1;
	};

	this.appendDigit = function (digit) {

		/**
   * currentNumber = "" -> prepares board to remove placeholder numbers
   * when a new number sequence is detected
   */

		if (emptyBoard) {

			currentNumber = "";
			emptyBoard = false;
		}

		if (!inputDirty) {

			if (digit === 0) {

				currentNumber = 0;

				return;
			} else if (digit === "." && !decimalCreated) {

				currentNumber = "0.";
				inputDirty = true;
				decimalCreated = true;
				return;
			}

			currentNumber = "";
		}

		if (digit === "." && !decimalCreated) {

			decimalCreated = true;
		} else if (digit === ".") {

			return;
		}

		/**
   * The current number has to be created as a string, or else,
   * if you add the (-) sign in the middle of keying a number
   * the number after the (-) will trigger an operation.
   */

		currentNumber += digit.toString();

		console.log("currentNumber: " + currentNumber);

		inputDirty = true;
	};

	this.getCurrentNumber = function () {

		return currentNumber;
	};

	/**
  * In Javascript, the maximum number of decimals is 17,
  * but floating point arithmetic is not always 100% accurate.
  *
  * For example:
  * let x = 0.2 + 0.1;         // x will be 0.30000000000000004
  *
  * To solve the problem above, it helps to multiply and divide:
  * let x = (0.2 * 10 + 0.1 * 10) / 10;       // x will be 0.3
  *
  * This function calculates the operand with the most digits and
  * generates a multiplier and divider that has a leading 1 with
  * as many zeroes as there are digits in the longer operand.
  * Note: decimal point and negative sign are not included in the
  * length.
  *
  * @param digitA
  * @param digitB
  * @returns {{numA: number, numB: number, buffer: string}} Modified operands.
  * The buffer is the divider.
  */

	var operationAccuracyHelper = function operationAccuracyHelper(digitA, digitB) {

		var tempA = digitA.toString().replace(".", "").replace("-", "");
		var tempB = digitB.toString().replace(".", "").replace("-", "");

		var zeroBooster = null;

		tempA > tempB ? zeroBooster = tempA.length : zeroBooster = tempB.length;

		var booster = "1";

		for (var i = 0; i < zeroBooster; i++) {

			booster += "0";
		}

		return {

			numA: digitA * booster,
			numB: digitB * booster,
			buffer: booster

		};
	};

	var executeOperation = function executeOperation() {

		console.log("Executing " + currentOperation);

		var digitA = numberStack.shift();
		var digitB = numberStack.shift();

		var accuracyBooster = null;
		var decimalOp = false;

		if (!isInt(digitA) || !isInt(digitB)) {

			accuracyBooster = operationAccuracyHelper(digitA, digitB);
			decimalOp = true;
		}

		switch (currentOperation) {

			case "addition":

				if (decimalOp) {

					currentOperationResult = (accuracyBooster.numA + accuracyBooster.numB) / accuracyBooster.buffer;
				} else {

					currentOperationResult = digitA + digitB;
				}

				break;
			case "subtraction":

				if (decimalOp) {

					currentOperationResult = (accuracyBooster.numA - accuracyBooster.numB) / accuracyBooster.buffer;
				} else {

					currentOperationResult = digitA - digitB;
				}

				break;
			case "multiplication":

				if (decimalOp) {

					currentOperationResult = digitA * digitB;
				} else {

					currentOperationResult = digitA * digitB;
				}

				break;
			case "division":

				if (decimalOp) {

					currentOperationResult = digitA / digitB;
				} else {

					currentOperationResult = digitA / digitB;
				}

				break;

			case "percentage":

				if (digitB === undefined) {

					currentOperationResult = parseFloat(digitA / 100);
				} else {

					numberStack.push(Number(digitA));
					numberStack.push(parseFloat(digitA * parseFloat(digitB / 100)));

					return;
				}

				break;

			default:
				console.log("Operation " + currentOperation + " has not been created.");

		}

		if (isInt(currentOperationResult)) {

			console.log("Result is an integer!");
		} else {

			console.log("Result is a float!");

			if (currentOperationResult) {

				console.log(currentOperationResult);

				if (currentOperationResult.toString().length > 16) {

					currentOperationResult = parseFloat(currentOperationResult).toFixed(14);
				}
			}
		}

		console.log("Result: " + currentOperationResult);

		currentNumber = currentOperationResult;
	};

	this.setCurrentOperation = function (op) {

		if (op === "resultant") {

			if (standBy) {

				numberStack.push(Number(currentNumber));

				executeOperation();

				numberStack.push(Number(currentNumber));

				numberStack.unshift(standByNum);

				currentOperation = standByOp;

				standBy = false;
			}

			if (numberStack === 2) {

				executeOperation();

				numberStack.push(Number(currentNumber));

				console.log(numberStack);

				inputDirty = false;
			}
		}

		/**
   * If there is nothing in numberStack & there is no input, do nothing
   * If there is nothing in numberStack & there is input, define an operation
   */

		if (numberStack.length === 0 && !inputDirty) {

			console.log("There is nothing to operate on");
		} else if (numberStack.length === 0 && inputDirty) {

			console.log("There is something to put in the stack!");

			currentOperation = op;

			numberStack.push(Number(currentNumber));
			console.log(numberStack);
			inputDirty = false;
			decimalCreated = false;
		}

		/** If there is one element in numberStack & there is no input,
   * define an operation or allow to switch operations
   * If there is one element in numberStack & there is input,
   * push the input into numberStack
   */

		if (numberStack.length === 1 && !inputDirty) {

			console.log("There is an element in the stack");
			currentOperation = op;
			console.log(currentOperation);

			if (op === "percentage") {

				executeOperation();
				numberStack.push(Number(currentNumber));
			}
		} else if (numberStack.length === 1 && inputDirty) {

			console.log("There is an element in the stack & a new number has been entered");

			numberStack.push(Number(currentNumber));
			console.log(numberStack);
			inputDirty = false;
			decimalCreated = false;

			/**
    * This will make the execution block to run.
    * The operation that was assigned to trigger the execution
    * will be stored after the execution is done as it will
    * leave one element in the stack ready to an operation
    */
		}

		/**
   * If there are two elements in numberStack,
   * execute the current operation
   */

		if (numberStack.length === 2) {

			console.log("Execute Operation");

			/**
    * The current operation could change prior to computation
    * when using the percentage operator (%) as a binary operator
    */

			if (op === "percentage") {

				var ongoingOp = currentOperation;

				currentOperation = op;
				executeOperation();

				currentOperation = ongoingOp;
				executeOperation();

				numberStack.push(Number(currentNumber));

				return;
			}

			if (currentOperation === "addition" || currentOperation === "subtraction") {

				if (op === "multiplication" || op === "division") {

					standBy = true;
					standByOp = currentOperation;
					standByNum = numberStack.shift();

					currentOperation = op;

					decimalCreated = false;
					inputDirty = false;

					return;
				}
			}

			if (currentOperation === "multiplication" || currentOperation === "division") {

				if ((op === "addition" || op === "subtraction") && standBy) {

					executeOperation();

					numberStack.push(Number(currentNumber));

					numberStack.unshift(standByNum);

					currentOperation = standByOp;

					executeOperation();

					numberStack.push(Number(currentNumber));

					currentOperation = op;

					standBy = false;
					standByOp = null;
					standByNum = null;

					decimalCreated = false;
					inputDirty = false;

					return;
				}
			}

			executeOperation();

			// Operation is complete. Add result to numberStack

			numberStack.push(Number(currentNumber));

			console.log(numberStack);

			currentOperation = op;
			console.log(currentOperation);

			decimalCreated = false;
			inputDirty = false;
		}
	};

	this.clearBoard = function () {

		console.log("CLEAR");

		emptyBoard = true;

		numberStack.length = 0;

		currentNumber = 0;
		currentOperation = null;
		currentOperationResult = null;

		decimalCreated = false;

		inputDirty = false;
	};

	this.flipSign = function () {

		console.log("flipSign");

		if (currentNumber == 0 || emptyBoard) {

			/**
    * Avoid NaN
    */

			return;
		}

		if (numberStack.length === 1 && !inputDirty) {

			var tempNum = numberStack.pop();

			currentNumber = tempNum * -1;

			numberStack.push(Number(currentNumber));
		} else {

			console.log(numberStack);

			currentNumber = currentNumber * -1;
		}
	};
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyaWRzL2JvYXJkR3JpZC5zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbImFuZ3VsYXIiLCJtb2R1bGUiLCJzZXJ2aWNlIiwiZW1wdHlCb2FyZCIsIm51bWJlclN0YWNrIiwiY3VycmVudE51bWJlciIsImN1cnJlbnRPcGVyYXRpb24iLCJjdXJyZW50T3BlcmF0aW9uUmVzdWx0Iiwic3RhbmRCeU9wIiwic3RhbmRCeSIsInN0YW5kQnlOdW0iLCJkZWNpbWFsQ3JlYXRlZCIsImlucHV0RGlydHkiLCJpc0ludCIsIm51bSIsImFwcGVuZERpZ2l0IiwiZGlnaXQiLCJ0b1N0cmluZyIsImNvbnNvbGUiLCJsb2ciLCJnZXRDdXJyZW50TnVtYmVyIiwib3BlcmF0aW9uQWNjdXJhY3lIZWxwZXIiLCJkaWdpdEEiLCJkaWdpdEIiLCJ0ZW1wQSIsInJlcGxhY2UiLCJ0ZW1wQiIsInplcm9Cb29zdGVyIiwibGVuZ3RoIiwiYm9vc3RlciIsImkiLCJudW1BIiwibnVtQiIsImJ1ZmZlciIsImV4ZWN1dGVPcGVyYXRpb24iLCJzaGlmdCIsImFjY3VyYWN5Qm9vc3RlciIsImRlY2ltYWxPcCIsInVuZGVmaW5lZCIsInBhcnNlRmxvYXQiLCJwdXNoIiwiTnVtYmVyIiwidG9GaXhlZCIsInNldEN1cnJlbnRPcGVyYXRpb24iLCJvcCIsInVuc2hpZnQiLCJvbmdvaW5nT3AiLCJjbGVhckJvYXJkIiwiZmxpcFNpZ24iLCJ0ZW1wTnVtIiwicG9wIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsUUFBUUMsTUFBUixDQUFlLE9BQWYsRUFDRUMsT0FERixDQUNVLGtCQURWLEVBQzhCLFlBQVk7O0FBRXhDLEtBQUlDLGFBQWEsSUFBakI7O0FBRUEsS0FBTUMsY0FBYyxFQUFwQjs7QUFFQSxLQUFJQyxnQkFBZ0IsSUFBcEI7QUFDQSxLQUFJQyxtQkFBbUIsSUFBdkI7QUFDQSxLQUFJQyx5QkFBeUIsSUFBN0I7O0FBRUEsS0FBSUMsWUFBWSxJQUFoQjtBQUNBLEtBQUlDLFVBQVUsS0FBZDtBQUNB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Z0IsQ0FBaEI7QUFDQUMscUJBQW1CLElBQW5CO0FBQ0FDLDJCQUF5QixJQUF6Qjs7QUFFQUksbUJBQWlCLEtBQWpCOztBQUVBQyxlQUFhLEtBQWI7QUFFQSxFQWhCRDs7QUFrQkEsTUFBS29DLFFBQUwsR0FBZ0IsWUFBWTs7QUFFM0I5QixVQUFRQyxHQUFSLENBQVksVUFBWjs7QUFFQSxNQUFJZCxpQkFBaUIsQ0FBakIsSUFBc0JGLFVBQTFCLEVBQXNDOztBQUVyQzs7OztBQUlBO0FBRUE7O0FBR0QsTUFBSUMsWUFBWXdCLE1BQVosS0FBdUIsQ0FBdkIsSUFBNEIsQ0FBQ2hCLFVBQWpDLEVBQTZDOztBQUU1QyxPQUFJcUMsVUFBVTdDLFlBQVk4QyxHQUFaLEVBQWQ7O0FBRUE3QyxtQkFBZ0I0QyxVQUFVLENBQUMsQ0FBM0I7O0FBRUE3QyxlQUFZb0MsSUFBWixDQUFpQkMsT0FBT3BDLGFBQVAsQ0FBakI7QUFFQSxHQVJELE1BUU87O0FBRU5hLFdBQVFDLEdBQVIsQ0FBWWYsV0FBWjs7QUFFQUMsbUJBQWdCQSxnQkFBZ0IsQ0FBQyxDQUFqQztBQUVBO0FBRUQsRUEvQkQ7QUFpQ0EsQ0FwZ0JGIiwiZmlsZSI6ImdyaWRzL2JvYXJkR3JpZC5zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmFuZ3VsYXIubW9kdWxlKFwiZ3JpZHNcIilcblx0LnNlcnZpY2UoXCJCb2FyZEdyaWRTZXJ2aWNlXCIsIGZ1bmN0aW9uICgpIHtcblx0XHRcblx0XHRsZXQgZW1wdHlCb2FyZCA9IHRydWU7XG5cdFx0XG5cdFx0Y29uc3QgbnVtYmVyU3RhY2sgPSBbXTtcblx0XHRcblx0XHRsZXQgY3VycmVudE51bWJlciA9IG51bGw7XG5cdFx0bGV0IGN1cnJlbnRPcGVyYXRpb24gPSBudWxsO1xuXHRcdGxldCBjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gbnVsbDtcblx0XHRcblx0XHRsZXQgc3RhbmRCeU9wID0gbnVsbDtcblx0XHRsZXQgc3RhbmRCeSA9IGZhbHNlO1xuXHRcdGxldCBzdGFuZEJ5TnVtID0gbnVsbDtcblx0XHRcblx0XHRsZXQgZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcblx0XHRsZXQgaW5wdXREaXJ0eSA9IGZhbHNlO1xuXHRcdFxuXHRcdFxuXHRcdGlmIChlbXB0eUJvYXJkKSB7XG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgPSBcIjBcIjtcblx0XHRcdFxuXHRcdH1cblx0XHRcblx0XHRsZXQgaXNJbnQgPSBmdW5jdGlvbiAobnVtKSB7XG5cdFx0XHRcblx0XHRcdHJldHVybiBudW0gJSAxID09PSAxO1xuXHRcdFx0XG5cdFx0fTtcblx0XHRcblx0XHRcblx0XHR0aGlzLmFwcGVuZERpZ2l0ID0gZnVuY3Rpb24gKGRpZ2l0KSB7XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogY3VycmVudE51bWJlciA9IFwiXCIgLT4gcHJlcGFyZXMgYm9hcmQgdG8gcmVtb3ZlIHBsYWNlaG9sZGVyIG51bWJlcnNcblx0XHRcdCAqIHdoZW4gYSBuZXcgbnVtYmVyIHNlcXVlbmNlIGlzIGRldGVjdGVkXG5cdFx0XHQgKi9cblx0XHRcdFxuXHRcdFx0XG5cdFx0XHRpZiAoZW1wdHlCb2FyZCkge1xuXHRcdFx0XHRcblx0XHRcdFx0Y3VycmVudE51bWJlciA9IFwiXCI7XG5cdFx0XHRcdGVtcHR5Qm9hcmQgPSBmYWxzZTtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdGlmICghaW5wdXREaXJ0eSkge1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKGRpZ2l0ID09PSAwKSB7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE51bWJlciA9IDA7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHR9IGVsc2UgaWYgKGRpZ2l0ID09PSBcIi5cIiAmJiAhZGVjaW1hbENyZWF0ZWQpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjdXJyZW50TnVtYmVyID0gIFwiMC5cIjtcblx0XHRcdFx0XHRpbnB1dERpcnR5ID0gdHJ1ZTtcblx0XHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IHRydWU7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0XHRjdXJyZW50TnVtYmVyID0gXCJcIjtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdGlmIChkaWdpdCA9PT0gXCIuXCIgJiYgIWRlY2ltYWxDcmVhdGVkKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IHRydWU7XG5cdFx0XHRcdFxuXHRcdFx0fSBlbHNlIGlmIChkaWdpdCA9PT0gXCIuXCIpIHtcblx0XHRcdFx0XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogVGhlIGN1cnJlbnQgbnVtYmVyIGhhcyB0byBiZSBjcmVhdGVkIGFzIGEgc3RyaW5nLCBvciBlbHNlLFxuXHRcdFx0ICogaWYgeW91IGFkZCB0aGUgKC0pIHNpZ24gaW4gdGhlIG1pZGRsZSBvZiBrZXlpbmcgYSBudW1iZXJcblx0XHRcdCAqIHRoZSBudW1iZXIgYWZ0ZXIgdGhlICgtKSB3aWxsIHRyaWdnZXIgYW4gb3BlcmF0aW9uLlxuXHRcdFx0ICovXG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgKz0gZGlnaXQudG9TdHJpbmcoKTtcblx0XHRcdFxuXHRcdFx0Y29uc29sZS5sb2coYGN1cnJlbnROdW1iZXI6ICR7Y3VycmVudE51bWJlcn1gKTtcblx0XHRcdFxuXHRcdFx0aW5wdXREaXJ0eSA9IHRydWU7XG5cdFx0XHRcblx0XHR9O1xuXHRcdFxuXHRcdHRoaXMuZ2V0Q3VycmVudE51bWJlciA9IGZ1bmN0aW9uICgpIHtcblxuXHRcdFx0cmV0dXJuIGN1cnJlbnROdW1iZXI7XG5cblx0XHR9O1xuXHRcdFxuXHRcdC8qKlxuXHRcdCAqIEluIEphdmFzY3JpcHQsIHRoZSBtYXhpbXVtIG51bWJlciBvZiBkZWNpbWFscyBpcyAxNyxcblx0XHQgKiBidXQgZmxvYXRpbmcgcG9pbnQgYXJpdGhtZXRpYyBpcyBub3QgYWx3YXlzIDEwMCUgYWNjdXJhdGUuXG5cdFx0ICpcblx0XHQgKiBGb3IgZXhhbXBsZTpcblx0XHQgKiBsZXQgeCA9IDAuMiArIDAuMTsgICAgICAgICAvLyB4IHdpbGwgYmUgMC4zMDAwMDAwMDAwMDAwMDAwNFxuXHRcdCAqXG5cdFx0ICogVG8gc29sdmUgdGhlIHByb2JsZW0gYWJvdmUsIGl0IGhlbHBzIHRvIG11bHRpcGx5IGFuZCBkaXZpZGU6XG5cdFx0ICogbGV0IHggPSAoMC4yICogMTAgKyAwLjEgKiAxMCkgLyAxMDsgICAgICAgLy8geCB3aWxsIGJlIDAuM1xuXHRcdCAqXG5cdFx0ICogVGhpcyBmdW5jdGlvbiBjYWxjdWxhdGVzIHRoZSBvcGVyYW5kIHdpdGggdGhlIG1vc3QgZGlnaXRzIGFuZFxuXHRcdCAqIGdlbmVyYXRlcyBhIG11bHRpcGxpZXIgYW5kIGRpdmlkZXIgdGhhdCBoYXMgYSBsZWFkaW5nIDEgd2l0aFxuXHRcdCAqIGFzIG1hbnkgemVyb2VzIGFzIHRoZXJlIGFyZSBkaWdpdHMgaW4gdGhlIGxvbmdlciBvcGVyYW5kLlxuXHRcdCAqIE5vdGU6IGRlY2ltYWwgcG9pbnQgYW5kIG5lZ2F0aXZlIHNpZ24gYXJlIG5vdCBpbmNsdWRlZCBpbiB0aGVcblx0XHQgKiBsZW5ndGguXG5cdFx0ICpcblx0XHQgKiBAcGFyYW0gZGlnaXRBXG5cdFx0ICogQHBhcmFtIGRpZ2l0QlxuXHRcdCAqIEByZXR1cm5zIHt7bnVtQTogbnVtYmVyLCBudW1COiBudW1iZXIsIGJ1ZmZlcjogc3RyaW5nfX0gTW9kaWZpZWQgb3BlcmFuZHMuXG5cdFx0ICogVGhlIGJ1ZmZlciBpcyB0aGUgZGl2aWRlci5cblx0XHQgKi9cblx0XHRcblx0XHRsZXQgb3BlcmF0aW9uQWNjdXJhY3lIZWxwZXIgPSBmdW5jdGlvbiAoZGlnaXRBLCBkaWdpdEIpIHtcblx0XHRcdFxuXHRcdFx0bGV0IHRlbXBBID0gZGlnaXRBLnRvU3RyaW5nKCkucmVwbGFjZShcIi5cIiwgXCJcIikucmVwbGFjZShcIi1cIiwgXCJcIik7XG5cdFx0XHRsZXQgdGVtcEIgPSBkaWdpdEIudG9TdHJpbmcoKS5yZXBsYWNlKFwiLlwiLCBcIlwiKS5yZXBsYWNlKFwiLVwiLCBcIlwiKTtcblx0XHRcdFxuXHRcdFx0bGV0IHplcm9Cb29zdGVyID0gbnVsbDtcblx0XHRcdFxuXHRcdFx0dGVtcEEgPiB0ZW1wQiA/IHplcm9Cb29zdGVyID0gdGVtcEEubGVuZ3RoIDogemVyb0Jvb3N0ZXIgPSB0ZW1wQi5sZW5ndGg7XG5cdFx0XHRcblx0XHRcdGxldCBib29zdGVyID0gXCIxXCI7XG5cdFx0XHRcblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgemVyb0Jvb3N0ZXI7IGkrKykge1xuXHRcdFx0XHRcblx0XHRcdFx0Ym9vc3RlciArPSBcIjBcIjtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFxuXHRcdFx0XHRudW1BOiBkaWdpdEEgKiBib29zdGVyLFxuXHRcdFx0XHRudW1COiBkaWdpdEIgKiBib29zdGVyLFxuXHRcdFx0XHRidWZmZXI6IGJvb3N0ZXJcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHR9O1xuXHRcdFxuXHRcdGNvbnN0IGV4ZWN1dGVPcGVyYXRpb24gPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcblx0XHRcdGNvbnNvbGUubG9nKGBFeGVjdXRpbmcgJHtjdXJyZW50T3BlcmF0aW9ufWApO1xuXHRcdFx0XG5cdFx0XHRjb25zdCBkaWdpdEEgPSBudW1iZXJTdGFjay5zaGlmdCgpO1xuXHRcdFx0Y29uc3QgZGlnaXRCID0gbnVtYmVyU3RhY2suc2hpZnQoKTtcblx0XHRcdFxuXHRcdFx0bGV0IGFjY3VyYWN5Qm9vc3RlciA9IG51bGw7XG5cdFx0XHRsZXQgZGVjaW1hbE9wID0gZmFsc2U7XG5cdFx0XHRcblx0XHRcdGlmICghaXNJbnQoZGlnaXRBKSB8fCAhaXNJbnQoZGlnaXRCKSkge1xuXHRcdFx0XHRcblx0XHRcdFx0YWNjdXJhY3lCb29zdGVyID0gb3BlcmF0aW9uQWNjdXJhY3lIZWxwZXIoZGlnaXRBLCBkaWdpdEIpO1xuXHRcdFx0XHRkZWNpbWFsT3AgPSB0cnVlO1xuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0c3dpdGNoIChjdXJyZW50T3BlcmF0aW9uKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjYXNlIFwiYWRkaXRpb25cIjpcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpZiAoZGVjaW1hbE9wKSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSAoYWNjdXJhY3lCb29zdGVyLm51bUEgKyBhY2N1cmFjeUJvb3N0ZXIubnVtQikgLyBhY2N1cmFjeUJvb3N0ZXIuYnVmZmVyO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IGRpZ2l0QSArIGRpZ2l0Qjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSBcInN1YnRyYWN0aW9uXCI6XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0aWYgKGRlY2ltYWxPcCkge1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gKGFjY3VyYWN5Qm9vc3Rlci5udW1BIC0gYWNjdXJhY3lCb29zdGVyLm51bUIpIC8gYWNjdXJhY3lCb29zdGVyLmJ1ZmZlcjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBkaWdpdEEgLSBkaWdpdEI7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGNhc2UgXCJtdWx0aXBsaWNhdGlvblwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmIChkZWNpbWFsT3ApIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IGRpZ2l0QSAqIGRpZ2l0Qjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBkaWdpdEEgKiBkaWdpdEI7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGNhc2UgXCJkaXZpc2lvblwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmIChkZWNpbWFsT3ApIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IGRpZ2l0QSAvIGRpZ2l0Qjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBkaWdpdEEgLyBkaWdpdEI7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdGNhc2UgXCJwZXJjZW50YWdlXCI6XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0aWYgKGRpZ2l0QiA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBwYXJzZUZsb2F0KGRpZ2l0QSAvIDEwMCk7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKE51bWJlcihkaWdpdEEpKTtcblx0XHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2gocGFyc2VGbG9hdChkaWdpdEEgKiBwYXJzZUZsb2F0KGRpZ2l0QiAvIDEwMCkpKTtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRcdGNvbnNvbGUubG9nKGBPcGVyYXRpb24gJHtjdXJyZW50T3BlcmF0aW9ufSBoYXMgbm90IGJlZW4gY3JlYXRlZC5gKTtcblx0XHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0XG5cdFx0XHRpZiAoaXNJbnQoY3VycmVudE9wZXJhdGlvblJlc3VsdCkpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKGBSZXN1bHQgaXMgYW4gaW50ZWdlciFgKTtcblx0XHRcdFx0XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc29sZS5sb2coYFJlc3VsdCBpcyBhIGZsb2F0IWApO1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKGN1cnJlbnRPcGVyYXRpb25SZXN1bHQpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhjdXJyZW50T3BlcmF0aW9uUmVzdWx0KTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpZiAoY3VycmVudE9wZXJhdGlvblJlc3VsdC50b1N0cmluZygpLmxlbmd0aCA+IDE2KSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBwYXJzZUZsb2F0KGN1cnJlbnRPcGVyYXRpb25SZXN1bHQpLnRvRml4ZWQoMTQpO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFxuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRjb25zb2xlLmxvZyhgUmVzdWx0OiAke2N1cnJlbnRPcGVyYXRpb25SZXN1bHR9YCk7XG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgPSBjdXJyZW50T3BlcmF0aW9uUmVzdWx0O1xuXHRcdFx0XG5cdFx0fTtcblx0XHRcblx0XHRcblx0XHR0aGlzLnNldEN1cnJlbnRPcGVyYXRpb24gPSBmdW5jdGlvbiAob3ApIHtcblx0XHRcdFxuXHRcdFx0aWYgKG9wID09PSBcInJlc3VsdGFudFwiKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAoc3RhbmRCeSkge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goTnVtYmVyKGN1cnJlbnROdW1iZXIpKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdG51bWJlclN0YWNrLnVuc2hpZnQoc3RhbmRCeU51bSk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IHN0YW5kQnlPcDtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRzdGFuZEJ5ID0gZmFsc2U7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHRcdGlmIChudW1iZXJTdGFjayA9PT0gMikge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGV4ZWN1dGVPcGVyYXRpb24oKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKE51bWJlcihjdXJyZW50TnVtYmVyKSk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y29uc29sZS5sb2cobnVtYmVyU3RhY2spO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcdFx0XHRcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0LyoqXG5cdFx0XHQgKiBJZiB0aGVyZSBpcyBub3RoaW5nIGluIG51bWJlclN0YWNrICYgdGhlcmUgaXMgbm8gaW5wdXQsIGRvIG5vdGhpbmdcblx0XHRcdCAqIElmIHRoZXJlIGlzIG5vdGhpbmcgaW4gbnVtYmVyU3RhY2sgJiB0aGVyZSBpcyBpbnB1dCwgZGVmaW5lIGFuIG9wZXJhdGlvblxuXHRcdFx0ICovXG5cdFx0XHRcblx0XHRcdGlmIChudW1iZXJTdGFjay5sZW5ndGggPT09IDAgJiYgIWlucHV0RGlydHkpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKFwiVGhlcmUgaXMgbm90aGluZyB0byBvcGVyYXRlIG9uXCIpO1xuXHRcdFx0XHRcblx0XHRcdH0gZWxzZSBpZiAobnVtYmVyU3RhY2subGVuZ3RoID09PSAwICYmIGlucHV0RGlydHkpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKFwiVGhlcmUgaXMgc29tZXRoaW5nIHRvIHB1dCBpbiB0aGUgc3RhY2shXCIpO1xuXHRcdFx0XHRcblx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9wO1xuXHRcdFx0XHRcblx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhudW1iZXJTdGFjayk7XG5cdFx0XHRcdGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcdFx0ZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdC8qKiBJZiB0aGVyZSBpcyBvbmUgZWxlbWVudCBpbiBudW1iZXJTdGFjayAmIHRoZXJlIGlzIG5vIGlucHV0LFxuXHRcdFx0ICogZGVmaW5lIGFuIG9wZXJhdGlvbiBvciBhbGxvdyB0byBzd2l0Y2ggb3BlcmF0aW9uc1xuXHRcdFx0ICogSWYgdGhlcmUgaXMgb25lIGVsZW1lbnQgaW4gbnVtYmVyU3RhY2sgJiB0aGVyZSBpcyBpbnB1dCxcblx0XHRcdCAqIHB1c2ggdGhlIGlucHV0IGludG8gbnVtYmVyU3RhY2tcblx0XHRcdCAqL1xuXHRcdFx0XG5cdFx0XHRpZiAobnVtYmVyU3RhY2subGVuZ3RoID09PSAxICYmICFpbnB1dERpcnR5KSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhcIlRoZXJlIGlzIGFuIGVsZW1lbnQgaW4gdGhlIHN0YWNrXCIpO1xuXHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uID0gb3A7XG5cdFx0XHRcdGNvbnNvbGUubG9nKGN1cnJlbnRPcGVyYXRpb24pO1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKG9wID09PSBcInBlcmNlbnRhZ2VcIikge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGV4ZWN1dGVPcGVyYXRpb24oKTtcblx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKE51bWJlcihjdXJyZW50TnVtYmVyKSk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHR9IGVsc2UgaWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMSAmJiBpbnB1dERpcnR5KSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhgVGhlcmUgaXMgYW4gZWxlbWVudCBpbiB0aGUgc3RhY2sgJiBhIG5ldyBudW1iZXIgaGFzIGJlZW4gZW50ZXJlZGApO1xuXHRcdFx0XHRcblx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhudW1iZXJTdGFjayk7XG5cdFx0XHRcdGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcdFx0ZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcdFx0XG5cdFx0XHRcdC8qKlxuXHRcdFx0XHQgKiBUaGlzIHdpbGwgbWFrZSB0aGUgZXhlY3V0aW9uIGJsb2NrIHRvIHJ1bi5cblx0XHRcdFx0ICogVGhlIG9wZXJhdGlvbiB0aGF0IHdhcyBhc3NpZ25lZCB0byB0cmlnZ2VyIHRoZSBleGVjdXRpb25cblx0XHRcdFx0ICogd2lsbCBiZSBzdG9yZWQgYWZ0ZXIgdGhlIGV4ZWN1dGlvbiBpcyBkb25lIGFzIGl0IHdpbGxcblx0XHRcdFx0ICogbGVhdmUgb25lIGVsZW1lbnQgaW4gdGhlIHN0YWNrIHJlYWR5IHRvIGFuIG9wZXJhdGlvblxuXHRcdFx0XHQgKi9cblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogSWYgdGhlcmUgYXJlIHR3byBlbGVtZW50cyBpbiBudW1iZXJTdGFjayxcblx0XHRcdCAqIGV4ZWN1dGUgdGhlIGN1cnJlbnQgb3BlcmF0aW9uXG5cdFx0XHQgKi9cblx0XHRcdFxuXHRcdFx0aWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMikge1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc29sZS5sb2coXCJFeGVjdXRlIE9wZXJhdGlvblwiKTtcblx0XHRcdFx0XG5cdFx0XHRcdC8qKlxuXHRcdFx0XHQgKiBUaGUgY3VycmVudCBvcGVyYXRpb24gY291bGQgY2hhbmdlIHByaW9yIHRvIGNvbXB1dGF0aW9uXG5cdFx0XHRcdCAqIHdoZW4gdXNpbmcgdGhlIHBlcmNlbnRhZ2Ugb3BlcmF0b3IgKCUpIGFzIGEgYmluYXJ5IG9wZXJhdG9yXG5cdFx0XHRcdCAqL1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKG9wID09PSBcInBlcmNlbnRhZ2VcIikge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGxldCBvbmdvaW5nT3AgPSBjdXJyZW50T3BlcmF0aW9uO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9uZ29pbmdPcDtcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHRcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdFx0aWYgKGN1cnJlbnRPcGVyYXRpb24gPT09IFwiYWRkaXRpb25cIiB8fCBjdXJyZW50T3BlcmF0aW9uID09PSBcInN1YnRyYWN0aW9uXCIpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpZiAob3AgPT09IFwibXVsdGlwbGljYXRpb25cIiB8fCBvcCA9PT0gXCJkaXZpc2lvblwiKSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdHN0YW5kQnkgPSB0cnVlO1xuXHRcdFx0XHRcdFx0c3RhbmRCeU9wID0gY3VycmVudE9wZXJhdGlvbjtcblx0XHRcdFx0XHRcdHN0YW5kQnlOdW0gPSBudW1iZXJTdGFjay5zaGlmdCgpO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uID0gb3A7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGRlY2ltYWxDcmVhdGVkID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdFx0aWYgKGN1cnJlbnRPcGVyYXRpb24gPT09IFwibXVsdGlwbGljYXRpb25cIiB8fCBjdXJyZW50T3BlcmF0aW9uID09PSBcImRpdmlzaW9uXCIpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpZiAoKG9wID09PSBcImFkZGl0aW9uXCIgfHwgb3AgPT09IFwic3VidHJhY3Rpb25cIikgJiYgc3RhbmRCeSkge1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goTnVtYmVyKGN1cnJlbnROdW1iZXIpKTtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0bnVtYmVyU3RhY2sudW5zaGlmdChzdGFuZEJ5TnVtKTtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IHN0YW5kQnlPcDtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0ZXhlY3V0ZU9wZXJhdGlvbigpO1xuXG5cdFx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKE51bWJlcihjdXJyZW50TnVtYmVyKSk7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRzdGFuZEJ5ID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRzdGFuZEJ5T3AgPSBudWxsO1xuXHRcdFx0XHRcdFx0c3RhbmRCeU51bSA9IG51bGw7XG5cblx0XHRcdFx0XHRcdGRlY2ltYWxDcmVhdGVkID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdFx0XG5cdFx0XHRcdGV4ZWN1dGVPcGVyYXRpb24oKTtcblx0XHRcdFx0XG5cdFx0XHRcdC8vIE9wZXJhdGlvbiBpcyBjb21wbGV0ZS4gQWRkIHJlc3VsdCB0byBudW1iZXJTdGFja1xuXHRcdFx0XHRcblx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc29sZS5sb2cobnVtYmVyU3RhY2spO1xuXHRcdFx0XHRcblx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9wO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhjdXJyZW50T3BlcmF0aW9uKTtcblx0XHRcdFx0XG5cdFx0XHRcdGRlY2ltYWxDcmVhdGVkID0gZmFsc2U7XG5cdFx0XHRcdGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHR9O1xuXHRcdFxuXHRcdHRoaXMuY2xlYXJCb2FyZCA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdFxuXHRcdFx0Y29uc29sZS5sb2coXCJDTEVBUlwiKTtcblx0XHRcdFxuXHRcdFx0ZW1wdHlCb2FyZCA9IHRydWU7XG5cdFx0XHRcblx0XHRcdG51bWJlclN0YWNrLmxlbmd0aCA9IDA7XG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgPSAwO1xuXHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG51bGw7XG5cdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gbnVsbDtcblx0XHRcdFxuXHRcdFx0ZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcdFxuXHRcdFx0aW5wdXREaXJ0eSA9IGZhbHNlO1xuXHRcdFx0XG5cdFx0fTtcblx0XHRcblx0XHR0aGlzLmZsaXBTaWduID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XG5cdFx0XHRjb25zb2xlLmxvZyhcImZsaXBTaWduXCIpO1xuXHRcdFx0XG5cdFx0XHRpZiAoY3VycmVudE51bWJlciA9PSAwIHx8IGVtcHR5Qm9hcmQpIHtcblx0XHRcdFx0XG5cdFx0XHRcdC8qKlxuXHRcdFx0XHQgKiBBdm9pZCBOYU5cblx0XHRcdFx0ICovXG5cdFx0XHRcdFxuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRcblx0XHRcdGlmIChudW1iZXJTdGFjay5sZW5ndGggPT09IDEgJiYgIWlucHV0RGlydHkpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGxldCB0ZW1wTnVtID0gbnVtYmVyU3RhY2sucG9wKCk7XG5cdFx0XHRcdFxuXHRcdFx0XHRjdXJyZW50TnVtYmVyID0gdGVtcE51bSAqIC0xO1xuXHRcdFx0XHRcblx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhudW1iZXJTdGFjayk7XG5cdFx0XHRcdFxuXHRcdFx0XHRjdXJyZW50TnVtYmVyID0gY3VycmVudE51bWJlciAqIC0xO1xuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdH1cblx0XHRcblx0fSk7XG4iXX0=
