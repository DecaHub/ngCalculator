"use strict";

angular.module("grids").service("BoardGridService", function () {

	var emptyBoard = true;

	var numberStack = [];

	var currentNumber = null;
	var currentOperation = null;
	var currentOperationResult = null;

	var standByOp = null;
	var standBy = false;
	var standByNum = null;

	var decimalCreated = false;

	var inputDirty = false;

	math.config({
		number: 'BigNumber',
		precision: 20
	});

	if (emptyBoard) {

		currentNumber = "0";
	}

	var isInt = function isInt(num) {

		return num % 1 === 1;
	};

	this.appendDigit = function (digit) {

		/**
   * currentNumber = "" -> prepares board to remove placeholder numbers
   * when a new number sequence is detected
   */

		if (emptyBoard) {

			currentNumber = "";
			emptyBoard = false;
		}

		if (!inputDirty) {

			if (digit === 0) {

				currentNumber = 0;

				return;
			} else if (digit === "." && !decimalCreated) {

				currentNumber = "0.";
				inputDirty = true;
				decimalCreated = true;
				return;
			}

			currentNumber = "";
		}

		if (digit === "." && !decimalCreated) {

			decimalCreated = true;
		} else if (digit === ".") {

			return;
		}

		/**
   * The current number has to be created as a string, or else,
   * if you add the (-) sign in the middle of keying a number
   * the number after the (-) will trigger an operation.
   */

		currentNumber += digit.toString();

		inputDirty = true;
	};

	this.getCurrentNumber = function () {

		return currentNumber;
	};

	var executeOperation = function executeOperation() {

		console.log("Executing " + currentOperation);

		var digitA = null;
		var digitB = null;

		if (numberStack.length > 1) {

			digitA = math.bignumber(numberStack.shift());
			digitB = math.bignumber(numberStack.shift());
		} else if (numberStack.length == 1) {

			digitA = math.bignumber(numberStack.shift());
		} else {

			return;
		}

		switch (currentOperation) {

			case "addition":

				currentOperationResult = math.add(digitA, digitB);

				break;
			case "subtraction":

				currentOperationResult = math.subtract(digitA, digitB);

				break;
			case "multiplication":

				currentOperationResult = math.multiply(digitA, digitB);

				break;
			case "division":

				currentOperationResult = math.divide(digitA, digitB);

				break;

			case "percentage":

				if (digitB === null) {

					currentOperationResult = math.divide(digitA, 100);
				} else {

					numberStack.push(digitA);
					numberStack.push(math.multiply(digitA, math.divide(digitB, 100)));

					return;
				}

				break;

			default:
				console.log("Operation " + currentOperation + " has not been created.");

		}

		if (isInt(currentOperationResult)) {

			console.log("Result is an integer!");
		} else {

			console.log("Result is a float!");

			if (currentOperationResult) {

				console.log(currentOperationResult);

				var decimalCounter = 0;
				var decimalString = currentOperationResult.toString();
				var dotPlace = null;
				var beforeDot = 0;

				for (var i = 0; i < decimalString.length; i++) {

					if (decimalString[i] === ".") {

						dotPlace = i;
						break;
					} else if (!isNaN(decimalString[i])) {

						beforeDot++;
					}
				}

				if (dotPlace !== null) {

					for (var _i = dotPlace + 1; _i < decimalString.length; _i++) {

						decimalCounter++;
					}
				}

				if (decimalCounter > 14 && beforeDot === 1) {

					currentOperationResult = parseFloat(currentOperationResult).toFixed(14);
				}
			}
		}

		console.log("Result: " + currentOperationResult);

		currentNumber = currentOperationResult;
	};

	this.setCurrentOperation = function (op) {

		if (op === "resultant") {

			if (standBy) {

				numberStack.push(currentNumber);

				executeOperation();

				numberStack.push(currentNumber);

				numberStack.unshift(standByNum);

				currentOperation = standByOp;

				standBy = false;
			}

			if (numberStack === 2) {

				executeOperation();

				numberStack.push(currentNumber);

				console.log(numberStack);

				inputDirty = false;
			}
		}

		/**
   * If there is nothing in numberStack & there is no input, do nothing
   * If there is nothing in numberStack & there is input, define an operation
   */

		if (numberStack.length === 0 && !inputDirty) {

			console.log("There is nothing to operate on");
		} else if (numberStack.length === 0 && inputDirty) {

			console.log("There is something to put in the stack!");

			currentOperation = op;

			numberStack.push(currentNumber);
			console.log(numberStack);
			inputDirty = false;
			decimalCreated = false;
		}

		/** If there is one element in numberStack & there is no input,
   * define an operation or allow to switch operations
   * If there is one element in numberStack & there is input,
   * push the input into numberStack
   */

		if (numberStack.length === 1 && !inputDirty) {

			console.log("There is an element in the stack");
			currentOperation = op;
			console.log(currentOperation);

			if (op === "percentage") {

				executeOperation();
				numberStack.push(currentNumber);
			}
		} else if (numberStack.length === 1 && inputDirty) {

			console.log("There is an element in the stack & a new number has been entered");

			numberStack.push(currentNumber);
			console.log(numberStack);
			inputDirty = false;
			decimalCreated = false;

			/**
    * This will make the execution block to run.
    * The operation that was assigned to trigger the execution
    * will be stored after the execution is done as it will
    * leave one element in the stack ready to an operation
    */
		}

		/**
   * If there are two elements in numberStack,
   * execute the current operation
   */

		if (numberStack.length === 2) {

			console.log("Execute Operation");

			/**
    * The current operation could change prior to computation
    * when using the percentage operator (%) as a binary operator
    */

			if (op === "percentage") {

				var ongoingOp = currentOperation;

				currentOperation = op;
				executeOperation();

				currentOperation = ongoingOp;
				executeOperation();

				numberStack.push(currentNumber);

				return;
			}

			if (currentOperation === "addition" || currentOperation === "subtraction") {

				if (op === "multiplication" || op === "division") {

					standBy = true;
					standByOp = currentOperation;
					standByNum = numberStack.shift();

					currentOperation = op;

					decimalCreated = false;
					inputDirty = false;

					return;
				}
			}

			if (currentOperation === "multiplication" || currentOperation === "division") {

				if ((op === "addition" || op === "subtraction") && standBy) {

					executeOperation();

					numberStack.push(currentNumber);

					numberStack.unshift(standByNum);

					currentOperation = standByOp;

					executeOperation();

					numberStack.push(currentNumber);

					currentOperation = op;

					standBy = false;
					standByOp = null;
					standByNum = null;

					decimalCreated = false;
					inputDirty = false;

					return;
				}
			}

			executeOperation();

			// Operation is complete. Add result to numberStack

			numberStack.push(currentNumber);

			console.log(numberStack);

			currentOperation = op;
			console.log(currentOperation);

			decimalCreated = false;
			inputDirty = false;
		}
	};

	this.clearBoard = function () {

		console.log("CLEAR");

		emptyBoard = true;

		numberStack.length = 0;

		currentNumber = 0;
		currentOperation = null;
		currentOperationResult = null;

		decimalCreated = false;

		inputDirty = false;
	};

	this.flipSign = function () {

		console.log("flipSign");

		if (currentNumber == 0 || emptyBoard) {

			/**
    * Avoid NaN
    */

			return;
		}

		if (numberStack.length === 1 && !inputDirty) {

			var tempNum = numberStack.pop();

			currentNumber = tempNum * -1;

			numberStack.push(currentNumber);
		} else {

			console.log(numberStack);

			currentNumber = currentNumber * -1;
		}
	};
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyaWRzL2JvYXJkR3JpZC5zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbImFuZ3VsYXIiLCJtb2R1bGUiLCJzZXJ2aWNlIiwiZW1wdHlCb2FyZCIsIm51bWJlclN0YWNrIiwiY3VycmVudE51bWJlciIsImN1cnJlbnRPcGVyYXRpb24iLCJjdXJyZW50T3BlcmF0aW9uUmVzdWx0Iiwic3RhbmRCeU9wIiwic3RhbmRCeSIsInN0YW5kQnlOdW0iLCJkZWNpbWFsQ3JlYXRlZCIsImlucHV0RGlydHkiLCJtYXRoIiwiY29uZmlnIiwibnVtYmVyIiwicHJlY2lzaW9uIiwiaXNJbnQiLCJudW0iLCJhcHBlbmREaWdpdCIsImRpZ2l0IiwidG9TdHJpbmciLCJnZXRDdXJyZW50TnVtYmVyIiwiZXhlY3V0ZU9wZXJhdGlvbiIsImNvbnNvbGUiLCJsb2ciLCJkaWdpdEEiLCJkaWdpdEIiLCJsZW5ndGgiLCJiaWdudW1iZXIiLCJzaGlmdCIsImFkZCIsInN1YnRyYWN0IiwibXVsdGlwbHkiLCJkaXZpZGUiLCJwdXNoIiwiZGVjaW1hbENvdW50ZXIiLCJkZWNpbWFsU3RyaW5nIiwiZG90UGxhY2UiLCJiZWZvcmVEb3QiLCJpIiwiaXNOYU4iLCJwYXJzZUZsb2F0IiwidG9GaXhlZCIsInNldEN1cnJlbnRPcGVyYXRpb24iLCJvcCIsInVuc2hpZnQiLCJvbmdvaW5nT3AiLCJjbGVhckJvYXJkIiwiZmxpcFNpZ24iLCJ0ZW1wTnVtIiwicG9wIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsUUFBUUMsTUFBUixDQUFlLE9BQWYsRUFDRUMsT0FERixDQUNVLGtCQURWLEVBQzhCLFlBQVk7O0FBRXhDLEtBQUlDLGFBQWEsSUFBakI7O0FBRUEsS0FBTUMsY0FBYyxFQUFwQjs7QUFFQSxLQUFJQyxnQkFBZ0IsSUFBcEI7QUFDQSxLQUFJQyxtQkFBbUIsSUFBdkI7QUFDQSxLQUFJQyx5QkFBeUIsSUFBN0I7O0FBRUEsS0FBSUMsWUFBWSxJQUFoQjtBQUNBLEtBQUlDLFVBQVUsS0FBZDtBQUNB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Q0FBaUI5QixhQUFqQjtBQUVBLEdBUkQsTUFRTzs7QUFFTm1CLFdBQVFDLEdBQVIsQ0FBWXJCLFdBQVo7O0FBRUFDLG1CQUFnQkEsZ0JBQWdCLENBQUMsQ0FBakM7QUFFQTtBQUVELEVBL0JEO0FBaUNBLENBNWRGIiwiZmlsZSI6ImdyaWRzL2JvYXJkR3JpZC5zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmFuZ3VsYXIubW9kdWxlKFwiZ3JpZHNcIilcblx0LnNlcnZpY2UoXCJCb2FyZEdyaWRTZXJ2aWNlXCIsIGZ1bmN0aW9uICgpIHtcblx0XHRcblx0XHRsZXQgZW1wdHlCb2FyZCA9IHRydWU7XG5cdFx0XG5cdFx0Y29uc3QgbnVtYmVyU3RhY2sgPSBbXTtcblx0XHRcblx0XHRsZXQgY3VycmVudE51bWJlciA9IG51bGw7XG5cdFx0bGV0IGN1cnJlbnRPcGVyYXRpb24gPSBudWxsO1xuXHRcdGxldCBjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gbnVsbDtcblx0XHRcblx0XHRsZXQgc3RhbmRCeU9wID0gbnVsbDtcblx0XHRsZXQgc3RhbmRCeSA9IGZhbHNlO1xuXHRcdGxldCBzdGFuZEJ5TnVtID0gbnVsbDtcblx0XHRcblx0XHRsZXQgZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcblx0XHRsZXQgaW5wdXREaXJ0eSA9IGZhbHNlO1xuXHRcdFxuXHRcdG1hdGguY29uZmlnKHtcblx0XHRcdG51bWJlcjogJ0JpZ051bWJlcicsXG5cdFx0XHRwcmVjaXNpb246IDIwXG5cdFx0fSk7XG5cdFx0XG5cdFx0XG5cdFx0aWYgKGVtcHR5Qm9hcmQpIHtcblx0XHRcdFxuXHRcdFx0Y3VycmVudE51bWJlciA9IFwiMFwiO1xuXHRcdFx0XG5cdFx0fVxuXHRcdFxuXHRcdGxldCBpc0ludCA9IGZ1bmN0aW9uIChudW0pIHtcblx0XHRcdFxuXHRcdFx0cmV0dXJuIG51bSAlIDEgPT09IDE7XG5cdFx0XHRcblx0XHR9O1xuXHRcdFxuXHRcdFxuXHRcdHRoaXMuYXBwZW5kRGlnaXQgPSBmdW5jdGlvbiAoZGlnaXQpIHtcblx0XHRcdFxuXHRcdFx0LyoqXG5cdFx0XHQgKiBjdXJyZW50TnVtYmVyID0gXCJcIiAtPiBwcmVwYXJlcyBib2FyZCB0byByZW1vdmUgcGxhY2Vob2xkZXIgbnVtYmVyc1xuXHRcdFx0ICogd2hlbiBhIG5ldyBudW1iZXIgc2VxdWVuY2UgaXMgZGV0ZWN0ZWRcblx0XHRcdCAqL1xuXHRcdFx0XG5cdFx0XHRcblx0XHRcdGlmIChlbXB0eUJvYXJkKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjdXJyZW50TnVtYmVyID0gXCJcIjtcblx0XHRcdFx0ZW1wdHlCb2FyZCA9IGZhbHNlO1xuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0aWYgKCFpbnB1dERpcnR5KSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAoZGlnaXQgPT09IDApIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjdXJyZW50TnVtYmVyID0gMDtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH0gZWxzZSBpZiAoZGlnaXQgPT09IFwiLlwiICYmICFkZWNpbWFsQ3JlYXRlZCkge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGN1cnJlbnROdW1iZXIgPSAgXCIwLlwiO1xuXHRcdFx0XHRcdGlucHV0RGlydHkgPSB0cnVlO1xuXHRcdFx0XHRcdGRlY2ltYWxDcmVhdGVkID0gdHJ1ZTtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHRcdGN1cnJlbnROdW1iZXIgPSBcIlwiO1xuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0aWYgKGRpZ2l0ID09PSBcIi5cIiAmJiAhZGVjaW1hbENyZWF0ZWQpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGRlY2ltYWxDcmVhdGVkID0gdHJ1ZTtcblx0XHRcdFx0XG5cdFx0XHR9IGVsc2UgaWYgKGRpZ2l0ID09PSBcIi5cIikge1xuXHRcdFx0XHRcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0LyoqXG5cdFx0XHQgKiBUaGUgY3VycmVudCBudW1iZXIgaGFzIHRvIGJlIGNyZWF0ZWQgYXMgYSBzdHJpbmcsIG9yIGVsc2UsXG5cdFx0XHQgKiBpZiB5b3UgYWRkIHRoZSAoLSkgc2lnbiBpbiB0aGUgbWlkZGxlIG9mIGtleWluZyBhIG51bWJlclxuXHRcdFx0ICogdGhlIG51bWJlciBhZnRlciB0aGUgKC0pIHdpbGwgdHJpZ2dlciBhbiBvcGVyYXRpb24uXG5cdFx0XHQgKi9cblx0XHRcdFxuXHRcdFx0Y3VycmVudE51bWJlciArPSBkaWdpdC50b1N0cmluZygpO1xuXHRcdFx0XG5cdFx0XHRpbnB1dERpcnR5ID0gdHJ1ZTtcblx0XHRcdFxuXHRcdH07XG5cdFx0XG5cdFx0dGhpcy5nZXRDdXJyZW50TnVtYmVyID0gZnVuY3Rpb24gKCkge1xuXG5cdFx0XHRyZXR1cm4gY3VycmVudE51bWJlcjtcblxuXHRcdH07XG5cdFx0XG5cdFx0Y29uc3QgZXhlY3V0ZU9wZXJhdGlvbiA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdFxuXHRcdFx0Y29uc29sZS5sb2coYEV4ZWN1dGluZyAke2N1cnJlbnRPcGVyYXRpb259YCk7XG5cdFx0XHRcblx0XHRcdGxldCBkaWdpdEEgPSBudWxsO1xuXHRcdFx0bGV0IGRpZ2l0QiA9IG51bGw7XG5cdFx0XHRcblx0XHRcdGlmIChudW1iZXJTdGFjay5sZW5ndGggPiAxKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRkaWdpdEEgPSBtYXRoLmJpZ251bWJlcihudW1iZXJTdGFjay5zaGlmdCgpKTtcblx0XHRcdFx0ZGlnaXRCID0gbWF0aC5iaWdudW1iZXIobnVtYmVyU3RhY2suc2hpZnQoKSk7XG5cdFx0XHRcdFxuXHRcdFx0fSBlbHNlIGlmIChudW1iZXJTdGFjay5sZW5ndGggPT0gMSkge1xuXHRcdFx0XHRcblx0XHRcdFx0ZGlnaXRBID0gbWF0aC5iaWdudW1iZXIobnVtYmVyU3RhY2suc2hpZnQoKSk7XG5cdFx0XHRcdFxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdFxuXHRcdFx0XG5cdFx0XHRzd2l0Y2ggKGN1cnJlbnRPcGVyYXRpb24pIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNhc2UgXCJhZGRpdGlvblwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBtYXRoLmFkZChkaWdpdEEsIGRpZ2l0Qik7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGNhc2UgXCJzdWJ0cmFjdGlvblwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBtYXRoLnN1YnRyYWN0KGRpZ2l0QSwgZGlnaXRCKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSBcIm11bHRpcGxpY2F0aW9uXCI6XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IG1hdGgubXVsdGlwbHkoZGlnaXRBLCBkaWdpdEIpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlIFwiZGl2aXNpb25cIjpcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gbWF0aC5kaXZpZGUoZGlnaXRBLCBkaWdpdEIpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRjYXNlIFwicGVyY2VudGFnZVwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmIChkaWdpdEIgPT09IG51bGwpIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IG1hdGguZGl2aWRlKGRpZ2l0QSwgIDEwMCk7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goZGlnaXRBKTtcblx0XHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2gobWF0aC5tdWx0aXBseShkaWdpdEEsIG1hdGguZGl2aWRlKGRpZ2l0QiwgMTAwKSkpO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coYE9wZXJhdGlvbiAke2N1cnJlbnRPcGVyYXRpb259IGhhcyBub3QgYmVlbiBjcmVhdGVkLmApO1xuXHRcdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRcblx0XHRcdGlmIChpc0ludChjdXJyZW50T3BlcmF0aW9uUmVzdWx0KSkge1xuXG5cdFx0XHRcdGNvbnNvbGUubG9nKGBSZXN1bHQgaXMgYW4gaW50ZWdlciFgKTtcblxuXHRcdFx0fSBlbHNlIHtcblxuXHRcdFx0XHRjb25zb2xlLmxvZyhgUmVzdWx0IGlzIGEgZmxvYXQhYCk7XG5cblx0XHRcdFx0aWYgKGN1cnJlbnRPcGVyYXRpb25SZXN1bHQpIHtcblxuXHRcdFx0XHRcdGNvbnNvbGUubG9nKGN1cnJlbnRPcGVyYXRpb25SZXN1bHQpO1xuXG5cdFx0XHRcdFx0bGV0IGRlY2ltYWxDb3VudGVyID0gMDtcblx0XHRcdFx0XHRsZXQgZGVjaW1hbFN0cmluZyA9IGN1cnJlbnRPcGVyYXRpb25SZXN1bHQudG9TdHJpbmcoKTtcblx0XHRcdFx0XHRsZXQgZG90UGxhY2UgPSBudWxsO1xuXHRcdFx0XHRcdGxldCBiZWZvcmVEb3QgPSAwO1xuXG5cdFx0XHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBkZWNpbWFsU3RyaW5nLmxlbmd0aDsgaSsrKSB7XG5cblx0XHRcdFx0XHRcdGlmIChkZWNpbWFsU3RyaW5nW2ldID09PSBcIi5cIikge1xuXG5cdFx0XHRcdFx0XHRcdGRvdFBsYWNlID0gaTtcblx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdFx0XHRcdH0gZWxzZSBpZiAoIWlzTmFOKGRlY2ltYWxTdHJpbmdbaV0pKSB7XG5cdFx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0XHRiZWZvcmVEb3QrKztcblx0XHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKGRvdFBsYWNlICE9PSBudWxsKSB7XG5cblx0XHRcdFx0XHRcdGZvciAobGV0IGkgPSBkb3RQbGFjZSArIDE7IGkgPCBkZWNpbWFsU3RyaW5nLmxlbmd0aDsgaSsrKSB7XG5cblx0XHRcdFx0XHRcdFx0ZGVjaW1hbENvdW50ZXIrKztcblxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGlmIChkZWNpbWFsQ291bnRlciA+IDE0ICYmIGJlZm9yZURvdCA9PT0gMSkge1xuXG5cdFx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gcGFyc2VGbG9hdChjdXJyZW50T3BlcmF0aW9uUmVzdWx0KS50b0ZpeGVkKDE0KTtcblxuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHR9XG5cblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0Y29uc29sZS5sb2coYFJlc3VsdDogJHtjdXJyZW50T3BlcmF0aW9uUmVzdWx0fWApO1xuXHRcdFx0XG5cdFx0XHRjdXJyZW50TnVtYmVyID0gY3VycmVudE9wZXJhdGlvblJlc3VsdDtcblx0XHRcdFxuXHRcdH07XG5cdFx0XG5cdFx0XG5cdFx0dGhpcy5zZXRDdXJyZW50T3BlcmF0aW9uID0gZnVuY3Rpb24gKG9wKSB7XG5cdFx0XHRcblx0XHRcdGlmIChvcCA9PT0gXCJyZXN1bHRhbnRcIikge1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKHN0YW5kQnkpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKGN1cnJlbnROdW1iZXIpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGV4ZWN1dGVPcGVyYXRpb24oKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKGN1cnJlbnROdW1iZXIpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdG51bWJlclN0YWNrLnVuc2hpZnQoc3RhbmRCeU51bSk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IHN0YW5kQnlPcDtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRzdGFuZEJ5ID0gZmFsc2U7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHRcdGlmIChudW1iZXJTdGFjayA9PT0gMikge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGV4ZWN1dGVPcGVyYXRpb24oKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKGN1cnJlbnROdW1iZXIpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGNvbnNvbGUubG9nKG51bWJlclN0YWNrKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogSWYgdGhlcmUgaXMgbm90aGluZyBpbiBudW1iZXJTdGFjayAmIHRoZXJlIGlzIG5vIGlucHV0LCBkbyBub3RoaW5nXG5cdFx0XHQgKiBJZiB0aGVyZSBpcyBub3RoaW5nIGluIG51bWJlclN0YWNrICYgdGhlcmUgaXMgaW5wdXQsIGRlZmluZSBhbiBvcGVyYXRpb25cblx0XHRcdCAqL1xuXHRcdFx0XG5cdFx0XHRpZiAobnVtYmVyU3RhY2subGVuZ3RoID09PSAwICYmICFpbnB1dERpcnR5KSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhcIlRoZXJlIGlzIG5vdGhpbmcgdG8gb3BlcmF0ZSBvblwiKTtcblx0XHRcdFx0XG5cdFx0XHR9IGVsc2UgaWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMCAmJiBpbnB1dERpcnR5KSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhcIlRoZXJlIGlzIHNvbWV0aGluZyB0byBwdXQgaW4gdGhlIHN0YWNrIVwiKTtcblx0XHRcdFx0XG5cdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0XG5cdFx0XHRcdG51bWJlclN0YWNrLnB1c2goY3VycmVudE51bWJlcik7XG5cdFx0XHRcdGNvbnNvbGUubG9nKG51bWJlclN0YWNrKTtcblx0XHRcdFx0aW5wdXREaXJ0eSA9IGZhbHNlO1xuXHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IGZhbHNlO1xuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0LyoqIElmIHRoZXJlIGlzIG9uZSBlbGVtZW50IGluIG51bWJlclN0YWNrICYgdGhlcmUgaXMgbm8gaW5wdXQsXG5cdFx0XHQgKiBkZWZpbmUgYW4gb3BlcmF0aW9uIG9yIGFsbG93IHRvIHN3aXRjaCBvcGVyYXRpb25zXG5cdFx0XHQgKiBJZiB0aGVyZSBpcyBvbmUgZWxlbWVudCBpbiBudW1iZXJTdGFjayAmIHRoZXJlIGlzIGlucHV0LFxuXHRcdFx0ICogcHVzaCB0aGUgaW5wdXQgaW50byBudW1iZXJTdGFja1xuXHRcdFx0ICovXG5cdFx0XHRcblx0XHRcdGlmIChudW1iZXJTdGFjay5sZW5ndGggPT09IDEgJiYgIWlucHV0RGlydHkpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKFwiVGhlcmUgaXMgYW4gZWxlbWVudCBpbiB0aGUgc3RhY2tcIik7XG5cdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0Y29uc29sZS5sb2coY3VycmVudE9wZXJhdGlvbik7XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAob3AgPT09IFwicGVyY2VudGFnZVwiKSB7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0ZXhlY3V0ZU9wZXJhdGlvbigpO1xuXHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goY3VycmVudE51bWJlcik7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHR9IGVsc2UgaWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMSAmJiBpbnB1dERpcnR5KSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhgVGhlcmUgaXMgYW4gZWxlbWVudCBpbiB0aGUgc3RhY2sgJiBhIG5ldyBudW1iZXIgaGFzIGJlZW4gZW50ZXJlZGApO1xuXHRcdFx0XHRcblx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChjdXJyZW50TnVtYmVyKTtcblx0XHRcdFx0Y29uc29sZS5sb2cobnVtYmVyU3RhY2spO1xuXHRcdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cdFx0XHRcdGRlY2ltYWxDcmVhdGVkID0gZmFsc2U7XG5cdFx0XHRcdFxuXHRcdFx0XHQvKipcblx0XHRcdFx0ICogVGhpcyB3aWxsIG1ha2UgdGhlIGV4ZWN1dGlvbiBibG9jayB0byBydW4uXG5cdFx0XHRcdCAqIFRoZSBvcGVyYXRpb24gdGhhdCB3YXMgYXNzaWduZWQgdG8gdHJpZ2dlciB0aGUgZXhlY3V0aW9uXG5cdFx0XHRcdCAqIHdpbGwgYmUgc3RvcmVkIGFmdGVyIHRoZSBleGVjdXRpb24gaXMgZG9uZSBhcyBpdCB3aWxsXG5cdFx0XHRcdCAqIGxlYXZlIG9uZSBlbGVtZW50IGluIHRoZSBzdGFjayByZWFkeSB0byBhbiBvcGVyYXRpb25cblx0XHRcdFx0ICovXG5cdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHQvKipcblx0XHRcdCAqIElmIHRoZXJlIGFyZSB0d28gZWxlbWVudHMgaW4gbnVtYmVyU3RhY2ssXG5cdFx0XHQgKiBleGVjdXRlIHRoZSBjdXJyZW50IG9wZXJhdGlvblxuXHRcdFx0ICovXG5cdFx0XHRcblx0XHRcdGlmIChudW1iZXJTdGFjay5sZW5ndGggPT09IDIpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKFwiRXhlY3V0ZSBPcGVyYXRpb25cIik7XG5cdFx0XHRcdFxuXHRcdFx0XHQvKipcblx0XHRcdFx0ICogVGhlIGN1cnJlbnQgb3BlcmF0aW9uIGNvdWxkIGNoYW5nZSBwcmlvciB0byBjb21wdXRhdGlvblxuXHRcdFx0XHQgKiB3aGVuIHVzaW5nIHRoZSBwZXJjZW50YWdlIG9wZXJhdG9yICglKSBhcyBhIGJpbmFyeSBvcGVyYXRvclxuXHRcdFx0XHQgKi9cblx0XHRcdFx0XG5cdFx0XHRcdGlmIChvcCA9PT0gXCJwZXJjZW50YWdlXCIpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRsZXQgb25nb2luZ09wID0gY3VycmVudE9wZXJhdGlvbjtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uID0gb3A7XG5cdFx0XHRcdFx0ZXhlY3V0ZU9wZXJhdGlvbigpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvbmdvaW5nT3A7XG5cdFx0XHRcdFx0ZXhlY3V0ZU9wZXJhdGlvbigpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goY3VycmVudE51bWJlcik7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAoY3VycmVudE9wZXJhdGlvbiA9PT0gXCJhZGRpdGlvblwiIHx8IGN1cnJlbnRPcGVyYXRpb24gPT09IFwic3VidHJhY3Rpb25cIikge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmIChvcCA9PT0gXCJtdWx0aXBsaWNhdGlvblwiIHx8IG9wID09PSBcImRpdmlzaW9uXCIpIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0c3RhbmRCeSA9IHRydWU7XG5cdFx0XHRcdFx0XHRzdGFuZEJ5T3AgPSBjdXJyZW50T3BlcmF0aW9uO1xuXHRcdFx0XHRcdFx0c3RhbmRCeU51bSA9IG51bWJlclN0YWNrLnNoaWZ0KCk7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0ZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcdFx0XHRcdGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFxuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAoY3VycmVudE9wZXJhdGlvbiA9PT0gXCJtdWx0aXBsaWNhdGlvblwiIHx8IGN1cnJlbnRPcGVyYXRpb24gPT09IFwiZGl2aXNpb25cIikge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmICgob3AgPT09IFwiYWRkaXRpb25cIiB8fCBvcCA9PT0gXCJzdWJ0cmFjdGlvblwiKSAmJiBzdGFuZEJ5KSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGV4ZWN1dGVPcGVyYXRpb24oKTtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChjdXJyZW50TnVtYmVyKTtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0bnVtYmVyU3RhY2sudW5zaGlmdChzdGFuZEJ5TnVtKTtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IHN0YW5kQnlPcDtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0ZXhlY3V0ZU9wZXJhdGlvbigpO1xuXG5cdFx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKGN1cnJlbnROdW1iZXIpO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uID0gb3A7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0c3RhbmRCeSA9IGZhbHNlO1xuXHRcdFx0XHRcdFx0c3RhbmRCeU9wID0gbnVsbDtcblx0XHRcdFx0XHRcdHN0YW5kQnlOdW0gPSBudWxsO1xuXG5cdFx0XHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IGZhbHNlO1xuXHRcdFx0XHRcdFx0aW5wdXREaXJ0eSA9IGZhbHNlO1xuXG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHRcdFxuXHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFxuXHRcdFx0XHQvLyBPcGVyYXRpb24gaXMgY29tcGxldGUuIEFkZCByZXN1bHQgdG8gbnVtYmVyU3RhY2tcblx0XHRcdFx0XG5cdFx0XHRcdG51bWJlclN0YWNrLnB1c2goY3VycmVudE51bWJlcik7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhudW1iZXJTdGFjayk7XG5cdFx0XHRcdFxuXHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uID0gb3A7XG5cdFx0XHRcdGNvbnNvbGUubG9nKGN1cnJlbnRPcGVyYXRpb24pO1xuXHRcdFx0XHRcblx0XHRcdFx0ZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcdFx0aW5wdXREaXJ0eSA9IGZhbHNlO1xuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdH07XG5cdFx0XG5cdFx0dGhpcy5jbGVhckJvYXJkID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XG5cdFx0XHRjb25zb2xlLmxvZyhcIkNMRUFSXCIpO1xuXHRcdFx0XG5cdFx0XHRlbXB0eUJvYXJkID0gdHJ1ZTtcblx0XHRcdFxuXHRcdFx0bnVtYmVyU3RhY2subGVuZ3RoID0gMDtcblx0XHRcdFxuXHRcdFx0Y3VycmVudE51bWJlciA9IDA7XG5cdFx0XHRjdXJyZW50T3BlcmF0aW9uID0gbnVsbDtcblx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBudWxsO1xuXHRcdFx0XG5cdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IGZhbHNlO1xuXHRcdFx0XG5cdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cdFx0XHRcblx0XHR9O1xuXHRcdFxuXHRcdHRoaXMuZmxpcFNpZ24gPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcblx0XHRcdGNvbnNvbGUubG9nKFwiZmxpcFNpZ25cIik7XG5cdFx0XHRcblx0XHRcdGlmIChjdXJyZW50TnVtYmVyID09IDAgfHwgZW1wdHlCb2FyZCkge1xuXHRcdFx0XHRcblx0XHRcdFx0LyoqXG5cdFx0XHRcdCAqIEF2b2lkIE5hTlxuXHRcdFx0XHQgKi9cblx0XHRcdFx0XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdFxuXHRcdFx0aWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMSAmJiAhaW5wdXREaXJ0eSkge1xuXHRcdFx0XHRcblx0XHRcdFx0bGV0IHRlbXBOdW0gPSBudW1iZXJTdGFjay5wb3AoKTtcblx0XHRcdFx0XG5cdFx0XHRcdGN1cnJlbnROdW1iZXIgPSB0ZW1wTnVtICogLTE7XG5cdFx0XHRcdFxuXHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKGN1cnJlbnROdW1iZXIpO1xuXHRcdFx0XHRcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhudW1iZXJTdGFjayk7XG5cdFx0XHRcdFxuXHRcdFx0XHRjdXJyZW50TnVtYmVyID0gY3VycmVudE51bWJlciAqIC0xO1xuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdH1cblx0XHRcblx0fSk7XG4iXX0=
