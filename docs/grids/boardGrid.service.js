"use strict";

angular.module("grids").service("BoardGridService", function () {

	var emptyBoard = true;

	var numberStack = [];

	var currentNumber = null;
	var currentOperation = null;
	var currentOperationResult = null;

	var decimalCreated = false;

	var inputDirty = false;

	if (emptyBoard) {

		currentNumber = "0";
	}

	var isInt = function isInt(num) {

		return num % 1 === 1;
	};

	this.appendDigit = function (digit) {

		/**
   * currentNumber = "" -> prepares board to remove placeholder numbers
   * when a new number sequence is detected
   */

		if (emptyBoard) {

			currentNumber = "";
			emptyBoard = false;
		}

		if (!inputDirty) {

			if (digit === 0) {

				currentNumber = 0;

				return;
			} else if (digit === "." && !decimalCreated) {

				currentNumber = "0.";
				inputDirty = true;
				decimalCreated = true;
				return;
			}

			currentNumber = "";
		}

		if (digit === "." && !decimalCreated) {

			decimalCreated = true;
		} else if (digit === ".") {

			return;
		}

		currentNumber += digit;
		inputDirty = true;
	};

	this.getCurrentNumber = function () {

		return currentNumber;
	};

	var executeOperation = function executeOperation() {

		console.log("Executing " + currentOperation);

		var digitA = numberStack.shift();
		var digitB = numberStack.shift();

		switch (currentOperation) {

			case "addition":

				if (!isInt(digitA) || !isInt(digitB)) {

					currentOperationResult = parseFloat(digitA) + digitB;
				} else {

					currentOperationResult = digitA + digitB;
				}

				break;
			case "subtraction":

				if (!isInt(digitA) || !isInt(digitB)) {

					currentOperationResult = parseFloat(digitA) - digitB;
				} else {

					currentOperationResult = digitA - digitB;
				}

				break;
			case "multiplication":

				if (!isInt(digitA) || !isInt(digitB)) {

					currentOperationResult = parseFloat(digitA) * digitB;
				} else {

					currentOperationResult = digitA * digitB;
				}

				break;
			case "division":

				if (!isInt(digitA) || !isInt(digitB)) {

					currentOperationResult = parseFloat(digitA) / digitB;
				} else {

					currentOperationResult = digitA / digitB;
				}

				break;

			case "percentage":

				if (digitB === undefined) {

					currentOperationResult = parseFloat(digitA / 100);
				} else {

					numberStack.push(Number(digitA));
					numberStack.push(parseFloat(digitA * parseFloat(digitB / 100)));

					return;
				}

				break;

			default:
				console.log("Operation " + currentOperation + " has not been created.");

		}

		if (isInt(currentOperationResult)) {

			console.log("Result is an integer!");
		} else {

			console.log("Result is a float!");

			if (currentOperationResult < 1) {

				console.log(currentOperationResult);

				if (currentOperationResult.toString().length > 16) {

					currentOperationResult = parseFloat(currentOperationResult).toFixed(15);
				}
			}
		}

		console.log("Result: " + currentOperationResult);

		currentNumber = currentOperationResult;
	};

	this.setCurrentOperation = function (op) {

		if (op === "resultant") {

			if (numberStack === 2) {

				executeOperation();

				numberStack.push(Number(currentNumber));

				console.log(numberStack);

				inputDirty = false;
			}
		}

		/**
   * If there is nothing in numberStack & there is no input, do nothing
   * If there is nothing in numberStack & there is input, define an operation
   */

		if (numberStack.length === 0 && !inputDirty) {

			console.log("There is nothing to operate on");
		} else if (numberStack.length === 0 && inputDirty) {

			console.log("There is something to put in the stack!");

			currentOperation = op;

			numberStack.push(Number(currentNumber));
			console.log(numberStack);
			inputDirty = false;
		}

		/** If there is one element in numberStack & there is no input,
   * define an operation or allow to switch operations
   * If there is one element in numberStack & there is input,
   * push the input into numberStack
   */

		if (numberStack.length === 1 && !inputDirty) {

			console.log("There is an element in the stack");
			currentOperation = op;
			console.log(currentOperation);

			if (op === "percentage") {

				executeOperation();
				numberStack.push(Number(currentNumber));
			}
		} else if (numberStack.length === 1 && inputDirty) {

			numberStack.push(Number(currentNumber));
			console.log(numberStack);
			inputDirty = false;

			/**
    * This will make the execution block to run.
    * The operation that was assigned to trigger the execution
    * will be stored after the execution is done as it will
    * leave one element in the stack ready to an operation
    */
		}

		/**
   * If there are two elements in numberStack,
   * execute the current operation
   */

		if (numberStack.length === 2) {

			console.log("Execute Operation");

			/**
    * The current operation could change prior to computation
    * when using the percentage operator (%) as a binary operator
    */

			if (op === "percentage") {

				var ongoingOp = currentOperation;

				currentOperation = op;
				executeOperation();

				currentOperation = ongoingOp;
				executeOperation();

				numberStack.push(Number(currentNumber));

				return;
			}

			executeOperation();

			// Operation is complete. Add result to numberStack

			numberStack.push(Number(currentNumber));

			console.log(numberStack);

			currentOperation = op;
			console.log(currentOperation);
		}
	};

	this.clearBoard = function () {

		console.log("CLEAR");

		emptyBoard = true;

		numberStack.length = 0;

		currentNumber = 0;
		currentOperation = null;
		currentOperationResult = null;

		decimalCreated = false;

		inputDirty = false;
	};

	this.flipSign = function () {

		numberStack.pop();

		currentNumber = currentNumber * -1;

		numberStack.push(Number(currentNumber));
	};
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyaWRzL2JvYXJkR3JpZC5zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbImFuZ3VsYXIiLCJtb2R1bGUiLCJzZXJ2aWNlIiwiZW1wdHlCb2FyZCIsIm51bWJlclN0YWNrIiwiY3VycmVudE51bWJlciIsImN1cnJlbnRPcGVyYXRpb24iLCJjdXJyZW50T3BlcmF0aW9uUmVzdWx0IiwiZGVjaW1hbENyZWF0ZWQiLCJpbnB1dERpcnR5IiwiaXNJbnQiLCJudW0iLCJhcHBlbmREaWdpdCIsImRpZ2l0IiwiZ2V0Q3VycmVudE51bWJlciIsImV4ZWN1dGVPcGVyYXRpb24iLCJjb25zb2xlIiwibG9nIiwiZGlnaXRBIiwic2hpZnQiLCJkaWdpdEIiLCJwYXJzZUZsb2F0IiwidW5kZWZpbmVkIiwicHVzaCIsIk51bWJlciIsInRvU3RyaW5nIiwibGVuZ3RoIiwidG9GaXhlZCIsInNldEN1cnJlbnRPcGVyYXRpb24iLCJvcCIsIm9uZ29pbmdPcCIsImNsZWFyQm9hcmQiLCJmbGlwU2lnbiIsInBvcCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUFBLFFBQVFDLE1BQVIsQ0FBZSxPQUFmLEVBQ0VDLE9BREYsQ0FDVSxrQkFEVixFQUM4QixZQUFZOztBQUV4QyxLQUFJQyxhQUFhLElBQWpCOztBQUVBLEtBQU1DLGNBQWMsRUFBcEI7O0FBRUEsS0FBSUMsZ0JBQWdCLElBQXBCO0FBQ0EsS0FBSUMsbUJBQW1CLElBQXZCO0FBQ0EsS0FBSUMseUJBQXlCLElBQTdCOztBQUVBLEtBQUlDLGlCQUFpQixLQUFyQjs7QUFFQSxLQUFJQyxhQUFhLEtBQWpCOztBQUdBLEtBQUlOLFVBQUosRUFBZ0I7O0FBRWZFLGtCQUFnQixHQUFoQjtBQUVBOztBQUVELEtBQUlLLFFBQVEsU0FBUkEsS0FBUSxDQUFVQyxHQUFWLEVBQWU7O0FBRTFCLFNBQU9BLE1BQU0sQ0FBTixLQUFZLENBQW5CO0FBRUEsRUFKRDs7QUFPQSxNQUFLQyxXQUFMLEdBQW1CLFVBQVVDLEtBQVYsRUFBaUI7O0FBRW5DOzs7OztB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QVk2QixHQUFaOztBQUVBNUIsa0JBQWdCQSxnQkFBZ0IsQ0FBQyxDQUFqQzs7QUFFQUQsY0FBWW1CLElBQVosQ0FBaUJDLE9BQU9uQixhQUFQLENBQWpCO0FBRUEsRUFSRDtBQVVBLENBM1ZGIiwiZmlsZSI6ImdyaWRzL2JvYXJkR3JpZC5zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmFuZ3VsYXIubW9kdWxlKFwiZ3JpZHNcIilcblx0LnNlcnZpY2UoXCJCb2FyZEdyaWRTZXJ2aWNlXCIsIGZ1bmN0aW9uICgpIHtcblx0XHRcblx0XHRsZXQgZW1wdHlCb2FyZCA9IHRydWU7XG5cdFx0XG5cdFx0Y29uc3QgbnVtYmVyU3RhY2sgPSBbXTtcblx0XHRcblx0XHRsZXQgY3VycmVudE51bWJlciA9IG51bGw7XG5cdFx0bGV0IGN1cnJlbnRPcGVyYXRpb24gPSBudWxsO1xuXHRcdGxldCBjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gbnVsbDtcblx0XHRcblx0XHRsZXQgZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcblx0XHRsZXQgaW5wdXREaXJ0eSA9IGZhbHNlO1xuXHRcdFxuXHRcdFxuXHRcdGlmIChlbXB0eUJvYXJkKSB7XG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgPSBcIjBcIjtcblx0XHRcdFxuXHRcdH1cblx0XHRcblx0XHRsZXQgaXNJbnQgPSBmdW5jdGlvbiAobnVtKSB7XG5cdFx0XHRcblx0XHRcdHJldHVybiBudW0gJSAxID09PSAxO1xuXHRcdFx0XG5cdFx0fTtcblx0XHRcblx0XHRcblx0XHR0aGlzLmFwcGVuZERpZ2l0ID0gZnVuY3Rpb24gKGRpZ2l0KSB7XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogY3VycmVudE51bWJlciA9IFwiXCIgLT4gcHJlcGFyZXMgYm9hcmQgdG8gcmVtb3ZlIHBsYWNlaG9sZGVyIG51bWJlcnNcblx0XHRcdCAqIHdoZW4gYSBuZXcgbnVtYmVyIHNlcXVlbmNlIGlzIGRldGVjdGVkXG5cdFx0XHQgKi9cblx0XHRcdFxuXHRcdFx0XG5cdFx0XHRpZiAoZW1wdHlCb2FyZCkge1xuXHRcdFx0XHRcblx0XHRcdFx0Y3VycmVudE51bWJlciA9IFwiXCI7XG5cdFx0XHRcdGVtcHR5Qm9hcmQgPSBmYWxzZTtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdGlmICghaW5wdXREaXJ0eSkge1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKGRpZ2l0ID09PSAwKSB7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE51bWJlciA9IDA7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHR9IGVsc2UgaWYgKGRpZ2l0ID09PSBcIi5cIiAmJiAhZGVjaW1hbENyZWF0ZWQpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjdXJyZW50TnVtYmVyID0gIFwiMC5cIjtcblx0XHRcdFx0XHRpbnB1dERpcnR5ID0gdHJ1ZTtcblx0XHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IHRydWU7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0XHRjdXJyZW50TnVtYmVyID0gXCJcIjtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdGlmIChkaWdpdCA9PT0gXCIuXCIgJiYgIWRlY2ltYWxDcmVhdGVkKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IHRydWU7XG5cdFx0XHRcdFxuXHRcdFx0fSBlbHNlIGlmIChkaWdpdCA9PT0gXCIuXCIpIHtcblx0XHRcdFx0XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgKz0gZGlnaXQ7XG5cdFx0XHRpbnB1dERpcnR5ID0gdHJ1ZTtcblx0XHRcdFxuXHRcdH07XG5cdFx0XG5cdFx0dGhpcy5nZXRDdXJyZW50TnVtYmVyID0gZnVuY3Rpb24gKCkge1xuXG5cdFx0XHRyZXR1cm4gY3VycmVudE51bWJlcjtcblxuXHRcdH07XG5cdFx0XG5cdFx0Y29uc3QgZXhlY3V0ZU9wZXJhdGlvbiA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdFxuXHRcdFx0Y29uc29sZS5sb2coYEV4ZWN1dGluZyAke2N1cnJlbnRPcGVyYXRpb259YCk7XG5cdFx0XHRcblx0XHRcdGNvbnN0IGRpZ2l0QSA9IG51bWJlclN0YWNrLnNoaWZ0KCk7XG5cdFx0XHRjb25zdCBkaWdpdEIgPSBudW1iZXJTdGFjay5zaGlmdCgpO1xuXHRcdFx0XG5cdFx0XHRzd2l0Y2ggKGN1cnJlbnRPcGVyYXRpb24pIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNhc2UgXCJhZGRpdGlvblwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmICghaXNJbnQoZGlnaXRBKSB8fCAhaXNJbnQoZGlnaXRCKSkge1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gcGFyc2VGbG9hdChkaWdpdEEpICsgZGlnaXRCO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IGRpZ2l0QSArIGRpZ2l0Qjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSBcInN1YnRyYWN0aW9uXCI6XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0aWYgKCFpc0ludChkaWdpdEEpIHx8ICFpc0ludChkaWdpdEIpKSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBwYXJzZUZsb2F0KGRpZ2l0QSkgLSBkaWdpdEI7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gZGlnaXRBIC0gZGlnaXRCO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlIFwibXVsdGlwbGljYXRpb25cIjpcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpZiAoIWlzSW50KGRpZ2l0QSkgfHwgIWlzSW50KGRpZ2l0QikpIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IHBhcnNlRmxvYXQoZGlnaXRBKSAqIGRpZ2l0Qjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBkaWdpdEEgKiBkaWdpdEI7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGNhc2UgXCJkaXZpc2lvblwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmICghaXNJbnQoZGlnaXRBKSB8fCAhaXNJbnQoZGlnaXRCKSkge1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gcGFyc2VGbG9hdChkaWdpdEEpIC8gZGlnaXRCO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IGRpZ2l0QSAvIGRpZ2l0Qjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcblx0XHRcdFx0Y2FzZSBcInBlcmNlbnRhZ2VcIjpcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpZiAoZGlnaXRCID09PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IHBhcnNlRmxvYXQoZGlnaXRBIC8gMTAwKTtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goTnVtYmVyKGRpZ2l0QSkpO1xuXHRcdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChwYXJzZUZsb2F0KGRpZ2l0QSAqIHBhcnNlRmxvYXQoZGlnaXRCIC8gMTAwKSkpO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coYE9wZXJhdGlvbiAke2N1cnJlbnRPcGVyYXRpb259IGhhcyBub3QgYmVlbiBjcmVhdGVkLmApO1xuXHRcdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRcblx0XHRcdGlmIChpc0ludChjdXJyZW50T3BlcmF0aW9uUmVzdWx0KSkge1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc29sZS5sb2coYFJlc3VsdCBpcyBhbiBpbnRlZ2VyIWApO1xuXHRcdFx0XHRcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhgUmVzdWx0IGlzIGEgZmxvYXQhYCk7XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAoY3VycmVudE9wZXJhdGlvblJlc3VsdCA8IDEpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhjdXJyZW50T3BlcmF0aW9uUmVzdWx0KTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpZiAoY3VycmVudE9wZXJhdGlvblJlc3VsdC50b1N0cmluZygpLmxlbmd0aCA+IDE2KSB7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBwYXJzZUZsb2F0KGN1cnJlbnRPcGVyYXRpb25SZXN1bHQpLnRvRml4ZWQoMTUpO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFxuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRjb25zb2xlLmxvZyhgUmVzdWx0OiAke2N1cnJlbnRPcGVyYXRpb25SZXN1bHR9YCk7XG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgPSBjdXJyZW50T3BlcmF0aW9uUmVzdWx0O1xuXHRcdFx0XG5cdFx0fTtcblx0XHRcblx0XHRcblx0XHR0aGlzLnNldEN1cnJlbnRPcGVyYXRpb24gPSBmdW5jdGlvbiAob3ApIHtcblx0XHRcdFxuXHRcdFx0aWYgKG9wID09PSBcInJlc3VsdGFudFwiKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAobnVtYmVyU3RhY2sgPT09IDIpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGNvbnNvbGUubG9nKG51bWJlclN0YWNrKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogSWYgdGhlcmUgaXMgbm90aGluZyBpbiBudW1iZXJTdGFjayAmIHRoZXJlIGlzIG5vIGlucHV0LCBkbyBub3RoaW5nXG5cdFx0XHQgKiBJZiB0aGVyZSBpcyBub3RoaW5nIGluIG51bWJlclN0YWNrICYgdGhlcmUgaXMgaW5wdXQsIGRlZmluZSBhbiBvcGVyYXRpb25cblx0XHRcdCAqL1xuXHRcdFx0XG5cdFx0XHRpZiAobnVtYmVyU3RhY2subGVuZ3RoID09PSAwICYmICFpbnB1dERpcnR5KSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhcIlRoZXJlIGlzIG5vdGhpbmcgdG8gb3BlcmF0ZSBvblwiKTtcblx0XHRcdFx0XG5cdFx0XHR9IGVsc2UgaWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMCAmJiBpbnB1dERpcnR5KSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRjb25zb2xlLmxvZyhcIlRoZXJlIGlzIHNvbWV0aGluZyB0byBwdXQgaW4gdGhlIHN0YWNrIVwiKTtcblx0XHRcdFx0XG5cdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0XG5cdFx0XHRcdG51bWJlclN0YWNrLnB1c2goTnVtYmVyKGN1cnJlbnROdW1iZXIpKTtcblx0XHRcdFx0Y29uc29sZS5sb2cobnVtYmVyU3RhY2spO1xuXHRcdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHQvKiogSWYgdGhlcmUgaXMgb25lIGVsZW1lbnQgaW4gbnVtYmVyU3RhY2sgJiB0aGVyZSBpcyBubyBpbnB1dCxcblx0XHRcdCAqIGRlZmluZSBhbiBvcGVyYXRpb24gb3IgYWxsb3cgdG8gc3dpdGNoIG9wZXJhdGlvbnNcblx0XHRcdCAqIElmIHRoZXJlIGlzIG9uZSBlbGVtZW50IGluIG51bWJlclN0YWNrICYgdGhlcmUgaXMgaW5wdXQsXG5cdFx0XHQgKiBwdXNoIHRoZSBpbnB1dCBpbnRvIG51bWJlclN0YWNrXG5cdFx0XHQgKi9cblx0XHRcdFxuXHRcdFx0aWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMSAmJiAhaW5wdXREaXJ0eSkge1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc29sZS5sb2coXCJUaGVyZSBpcyBhbiBlbGVtZW50IGluIHRoZSBzdGFja1wiKTtcblx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9wO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhjdXJyZW50T3BlcmF0aW9uKTtcblx0XHRcdFx0XG5cdFx0XHRcdGlmIChvcCA9PT0gXCJwZXJjZW50YWdlXCIpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0fSBlbHNlIGlmIChudW1iZXJTdGFjay5sZW5ndGggPT09IDEgJiYgaW5wdXREaXJ0eSkge1xuXHRcdFx0XHRcblx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhudW1iZXJTdGFjayk7XG5cdFx0XHRcdGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcdFx0XG5cdFx0XHRcdC8qKlxuXHRcdFx0XHQgKiBUaGlzIHdpbGwgbWFrZSB0aGUgZXhlY3V0aW9uIGJsb2NrIHRvIHJ1bi5cblx0XHRcdFx0ICogVGhlIG9wZXJhdGlvbiB0aGF0IHdhcyBhc3NpZ25lZCB0byB0cmlnZ2VyIHRoZSBleGVjdXRpb25cblx0XHRcdFx0ICogd2lsbCBiZSBzdG9yZWQgYWZ0ZXIgdGhlIGV4ZWN1dGlvbiBpcyBkb25lIGFzIGl0IHdpbGxcblx0XHRcdFx0ICogbGVhdmUgb25lIGVsZW1lbnQgaW4gdGhlIHN0YWNrIHJlYWR5IHRvIGFuIG9wZXJhdGlvblxuXHRcdFx0XHQgKi9cblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogSWYgdGhlcmUgYXJlIHR3byBlbGVtZW50cyBpbiBudW1iZXJTdGFjayxcblx0XHRcdCAqIGV4ZWN1dGUgdGhlIGN1cnJlbnQgb3BlcmF0aW9uXG5cdFx0XHQgKi9cblx0XHRcdFxuXHRcdFx0aWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMikge1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc29sZS5sb2coXCJFeGVjdXRlIE9wZXJhdGlvblwiKTtcblx0XHRcdFx0XG5cdFx0XHRcdC8qKlxuXHRcdFx0XHQgKiBUaGUgY3VycmVudCBvcGVyYXRpb24gY291bGQgY2hhbmdlIHByaW9yIHRvIGNvbXB1dGF0aW9uXG5cdFx0XHRcdCAqIHdoZW4gdXNpbmcgdGhlIHBlcmNlbnRhZ2Ugb3BlcmF0b3IgKCUpIGFzIGEgYmluYXJ5IG9wZXJhdG9yXG5cdFx0XHRcdCAqL1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKG9wID09PSBcInBlcmNlbnRhZ2VcIikge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGxldCBvbmdvaW5nT3AgPSBjdXJyZW50T3BlcmF0aW9uO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9uZ29pbmdPcDtcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHRcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdFx0XG5cdFx0XHRcdGV4ZWN1dGVPcGVyYXRpb24oKTtcblx0XHRcdFx0XG5cdFx0XHRcdC8vIE9wZXJhdGlvbiBpcyBjb21wbGV0ZS4gQWRkIHJlc3VsdCB0byBudW1iZXJTdGFja1xuXHRcdFx0XHRcblx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc29sZS5sb2cobnVtYmVyU3RhY2spO1xuXHRcdFx0XHRcblx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9wO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhjdXJyZW50T3BlcmF0aW9uKTtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHR9O1xuXHRcdFxuXHRcdHRoaXMuY2xlYXJCb2FyZCA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdFxuXHRcdFx0Y29uc29sZS5sb2coXCJDTEVBUlwiKTtcblx0XHRcdFxuXHRcdFx0ZW1wdHlCb2FyZCA9IHRydWU7XG5cdFx0XHRcblx0XHRcdG51bWJlclN0YWNrLmxlbmd0aCA9IDA7XG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgPSAwO1xuXHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG51bGw7XG5cdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gbnVsbDtcblx0XHRcdFxuXHRcdFx0ZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcdFxuXHRcdFx0aW5wdXREaXJ0eSA9IGZhbHNlO1xuXHRcdFx0XG5cdFx0fTtcblx0XHRcblx0XHR0aGlzLmZsaXBTaWduID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XG5cdFx0XHRudW1iZXJTdGFjay5wb3AoKTtcblx0XHRcdFxuXHRcdFx0Y3VycmVudE51bWJlciA9IGN1cnJlbnROdW1iZXIgKiAtMTtcblx0XHRcdFxuXHRcdFx0bnVtYmVyU3RhY2sucHVzaChOdW1iZXIoY3VycmVudE51bWJlcikpO1xuXHRcdFx0XG5cdFx0fVxuXHRcdFxuXHR9KTtcbiJdfQ==
