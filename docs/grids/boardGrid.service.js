"use strict";

angular.module("grids").service("BoardGridService", function () {

	var emptyBoard = true;

	var numberStack = [];

	var currentNumber = null;
	var currentOperation = null;
	var currentOperationResult = null;

	var standByOp = null;
	var standBy = false;
	var standByNum = null;

	var decimalCreated = false;

	var inputDirty = false;

	math.config({
		number: 'BigNumber',
		precision: 20
	});

	if (emptyBoard) {

		currentNumber = "0";
	}

	var isInt = function isInt(num) {

		return num % 1 === 1;
	};

	this.appendDigit = function (digit) {

		/**
   * currentNumber = "" -> prepares board to remove placeholder numbers
   * when a new number sequence is detected
   */

		if (emptyBoard) {

			currentNumber = "";
			emptyBoard = false;
		}

		if (!inputDirty) {

			if (digit === 0) {

				currentNumber = 0;

				return;
			} else if (digit === "." && !decimalCreated) {

				currentNumber = "0.";
				inputDirty = true;
				decimalCreated = true;
				return;
			}

			currentNumber = "";
		}

		if (digit === "." && !decimalCreated) {

			decimalCreated = true;
		} else if (digit === ".") {

			return;
		}

		/**
   * The current number has to be created as a string, or else,
   * if you add the (-) sign in the middle of keying a number
   * the number after the (-) will trigger an operation.
   */

		currentNumber += digit.toString();

		inputDirty = true;
	};

	this.getCurrentNumber = function () {

		return currentNumber;
	};

	var executeOperation = function executeOperation() {

		console.log("Executing " + currentOperation);

		var digitA = math.bignumber(numberStack.shift());
		var digitB = math.bignumber(numberStack.shift());

		switch (currentOperation) {

			case "addition":

				currentOperationResult = math.add(digitA, digitB);

				break;
			case "subtraction":

				currentOperationResult = math.subtract(digitA, digitB);

				break;
			case "multiplication":

				currentOperationResult = math.multiply(digitA, digitB);

				break;
			case "division":

				currentOperationResult = math.divide(digitA, digitB);

				break;

			case "percentage":

				if (digitB === undefined) {

					currentOperationResult = parseFloat(digitA / 100);
				} else {

					numberStack.push(digitA);
					numberStack.push(parseFloat(digitA * parseFloat(digitB / 100)));

					return;
				}

				break;

			default:
				console.log("Operation " + currentOperation + " has not been created.");

		}

		if (isInt(currentOperationResult)) {

			console.log("Result is an integer!");
		} else {

			console.log("Result is a float!");

			if (currentOperationResult) {

				console.log(currentOperationResult);

				var decimalCounter = 0;
				var decimalString = currentOperationResult.toString();
				var dotPlace = null;
				var beforeDot = 0;

				for (var i = 0; i < decimalString.length; i++) {

					if (decimalString[i] === ".") {

						dotPlace = i;
						break;
					} else if (!isNaN(decimalString[i])) {

						beforeDot++;
					}
				}

				if (dotPlace !== null) {

					for (var _i = dotPlace + 1; _i < decimalString.length; _i++) {

						decimalCounter++;
					}
				}

				if (decimalCounter > 14 && beforeDot === 1) {

					currentOperationResult = parseFloat(currentOperationResult).toFixed(14);
				}
			}
		}

		console.log("Result: " + currentOperationResult);

		currentNumber = currentOperationResult;
	};

	this.setCurrentOperation = function (op) {

		if (op === "resultant") {

			if (standBy) {

				numberStack.push(currentNumber);

				executeOperation();

				numberStack.push(currentNumber);

				numberStack.unshift(standByNum);

				currentOperation = standByOp;

				standBy = false;
			}

			if (numberStack === 2) {

				executeOperation();

				numberStack.push(currentNumber);

				console.log(numberStack);

				inputDirty = false;
			}
		}

		/**
   * If there is nothing in numberStack & there is no input, do nothing
   * If there is nothing in numberStack & there is input, define an operation
   */

		if (numberStack.length === 0 && !inputDirty) {

			console.log("There is nothing to operate on");
		} else if (numberStack.length === 0 && inputDirty) {

			console.log("There is something to put in the stack!");

			currentOperation = op;

			numberStack.push(currentNumber);
			console.log(numberStack);
			inputDirty = false;
			decimalCreated = false;
		}

		/** If there is one element in numberStack & there is no input,
   * define an operation or allow to switch operations
   * If there is one element in numberStack & there is input,
   * push the input into numberStack
   */

		if (numberStack.length === 1 && !inputDirty) {

			console.log("There is an element in the stack");
			currentOperation = op;
			console.log(currentOperation);

			if (op === "percentage") {

				executeOperation();
				numberStack.push(currentNumber);
			}
		} else if (numberStack.length === 1 && inputDirty) {

			console.log("There is an element in the stack & a new number has been entered");

			numberStack.push(currentNumber);
			console.log(numberStack);
			inputDirty = false;
			decimalCreated = false;

			/**
    * This will make the execution block to run.
    * The operation that was assigned to trigger the execution
    * will be stored after the execution is done as it will
    * leave one element in the stack ready to an operation
    */
		}

		/**
   * If there are two elements in numberStack,
   * execute the current operation
   */

		if (numberStack.length === 2) {

			console.log("Execute Operation");

			/**
    * The current operation could change prior to computation
    * when using the percentage operator (%) as a binary operator
    */

			if (op === "percentage") {

				var ongoingOp = currentOperation;

				currentOperation = op;
				executeOperation();

				currentOperation = ongoingOp;
				executeOperation();

				numberStack.push(currentNumber);

				return;
			}

			if (currentOperation === "addition" || currentOperation === "subtraction") {

				if (op === "multiplication" || op === "division") {

					standBy = true;
					standByOp = currentOperation;
					standByNum = numberStack.shift();

					currentOperation = op;

					decimalCreated = false;
					inputDirty = false;

					return;
				}
			}

			if (currentOperation === "multiplication" || currentOperation === "division") {

				if ((op === "addition" || op === "subtraction") && standBy) {

					executeOperation();

					numberStack.push(currentNumber);

					numberStack.unshift(standByNum);

					currentOperation = standByOp;

					executeOperation();

					numberStack.push(currentNumber);

					currentOperation = op;

					standBy = false;
					standByOp = null;
					standByNum = null;

					decimalCreated = false;
					inputDirty = false;

					return;
				}
			}

			executeOperation();

			// Operation is complete. Add result to numberStack

			numberStack.push(currentNumber);

			console.log(numberStack);

			currentOperation = op;
			console.log(currentOperation);

			decimalCreated = false;
			inputDirty = false;
		}
	};

	this.clearBoard = function () {

		console.log("CLEAR");

		emptyBoard = true;

		numberStack.length = 0;

		currentNumber = 0;
		currentOperation = null;
		currentOperationResult = null;

		decimalCreated = false;

		inputDirty = false;
	};

	this.flipSign = function () {

		console.log("flipSign");

		if (currentNumber == 0 || emptyBoard) {

			/**
    * Avoid NaN
    */

			return;
		}

		if (numberStack.length === 1 && !inputDirty) {

			var tempNum = numberStack.pop();

			currentNumber = tempNum * -1;

			numberStack.push(currentNumber);
		} else {

			console.log(numberStack);

			currentNumber = currentNumber * -1;
		}
	};
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyaWRzL2JvYXJkR3JpZC5zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbImFuZ3VsYXIiLCJtb2R1bGUiLCJzZXJ2aWNlIiwiZW1wdHlCb2FyZCIsIm51bWJlclN0YWNrIiwiY3VycmVudE51bWJlciIsImN1cnJlbnRPcGVyYXRpb24iLCJjdXJyZW50T3BlcmF0aW9uUmVzdWx0Iiwic3RhbmRCeU9wIiwic3RhbmRCeSIsInN0YW5kQnlOdW0iLCJkZWNpbWFsQ3JlYXRlZCIsImlucHV0RGlydHkiLCJtYXRoIiwiY29uZmlnIiwibnVtYmVyIiwicHJlY2lzaW9uIiwiaXNJbnQiLCJudW0iLCJhcHBlbmREaWdpdCIsImRpZ2l0IiwidG9TdHJpbmciLCJnZXRDdXJyZW50TnVtYmVyIiwiZXhlY3V0ZU9wZXJhdGlvbiIsImNvbnNvbGUiLCJsb2ciLCJkaWdpdEEiLCJiaWdudW1iZXIiLCJzaGlmdCIsImRpZ2l0QiIsImFkZCIsInN1YnRyYWN0IiwibXVsdGlwbHkiLCJkaXZpZGUiLCJ1bmRlZmluZWQiLCJwYXJzZUZsb2F0IiwicHVzaCIsImRlY2ltYWxDb3VudGVyIiwiZGVjaW1hbFN0cmluZyIsImRvdFBsYWNlIiwiYmVmb3JlRG90IiwiaSIsImxlbmd0aCIsImlzTmFOIiwidG9GaXhlZCIsInNldEN1cnJlbnRPcGVyYXRpb24iLCJvcCIsInVuc2hpZnQiLCJvbmdvaW5nT3AiLCJjbGVhckJvYXJkIiwiZmxpcFNpZ24iLCJ0ZW1wTnVtIiwicG9wIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsUUFBUUMsTUFBUixDQUFlLE9BQWYsRUFDRUMsT0FERixDQUNVLGtCQURWLEVBQzhCLFlBQVk7O0FBRXhDLEtBQUlDLGFBQWEsSUFBakI7O0FBRUEsS0FBTUMsY0FBYyxFQUFwQjs7QUFFQSxLQUFJQyxnQkFBZ0IsSUFBcEI7QUFDQSxLQUFJQyxtQkFBbUIsSUFBdkI7QUFDQSxLQUFJQyx5QkFBeUIsSUFBN0I7O0FBRUEsS0FBSUMsWUFBWSxJQUFoQjtBQUNBLEtBQUlDLFVB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SUFBWixDQUFpQi9CLGFBQWpCOztBQUVBbUIsV0FBUUMsR0FBUixDQUFZckIsV0FBWjs7QUFFQUUsc0JBQW1Cd0MsRUFBbkI7QUFDQXRCLFdBQVFDLEdBQVIsQ0FBWW5CLGdCQUFaOztBQUVBSyxvQkFBaUIsS0FBakI7QUFDQUMsZ0JBQWEsS0FBYjtBQUVBO0FBRUQsRUEvTEQ7O0FBaU1BLE1BQUtxQyxVQUFMLEdBQWtCLFlBQVk7O0FBRTdCekIsVUFBUUMsR0FBUixDQUFZLE9BQVo7O0FBRUF0QixlQUFhLElBQWI7O0FBRUFDLGNBQVlzQyxNQUFaLEdBQXFCLENBQXJCOztBQUVBckMsa0JBQWdCLENBQWhCO0FBQ0FDLHFCQUFtQixJQUFuQjtBQUNBQywyQkFBeUIsSUFBekI7O0FBRUFJLG1CQUFpQixLQUFqQjs7QUFFQUMsZUFBYSxLQUFiO0FBRUEsRUFoQkQ7O0FBa0JBLE1BQUtzQyxRQUFMLEdBQWdCLFlBQVk7O0FBRTNCMUIsVUFBUUMsR0FBUixDQUFZLFVBQVo7O0FBRUEsTUFBSXBCLGlCQUFpQixDQUFqQixJQUFzQkYsVUFBMUIsRUFBc0M7O0FBRXJDOzs7O0FBSUE7QUFFQTs7QUFHRCxNQUFJQyxZQUFZc0MsTUFBWixLQUF1QixDQUF2QixJQUE0QixDQUFDOUIsVUFBakMsRUFBNkM7O0FBRTVDLE9BQUl1QyxVQUFVL0MsWUFBWWdELEdBQVosRUFBZDs7QUFFQS9DLG1CQUFnQjhDLFVBQVUsQ0FBQyxDQUEzQjs7QUFFQS9DLGVBQVlnQyxJQUFaLENBQWlCL0IsYUFBakI7QUFFQSxHQVJELE1BUU87O0FBRU5tQixXQUFRQyxHQUFSLENBQVlyQixXQUFaOztBQUVBQyxtQkFBZ0JBLGdCQUFnQixDQUFDLENBQWpDO0FBRUE7QUFFRCxFQS9CRDtBQWlDQSxDQTFjRiIsImZpbGUiOiJncmlkcy9ib2FyZEdyaWQuc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5hbmd1bGFyLm1vZHVsZShcImdyaWRzXCIpXG5cdC5zZXJ2aWNlKFwiQm9hcmRHcmlkU2VydmljZVwiLCBmdW5jdGlvbiAoKSB7XG5cdFx0XG5cdFx0bGV0IGVtcHR5Qm9hcmQgPSB0cnVlO1xuXHRcdFxuXHRcdGNvbnN0IG51bWJlclN0YWNrID0gW107XG5cdFx0XG5cdFx0bGV0IGN1cnJlbnROdW1iZXIgPSBudWxsO1xuXHRcdGxldCBjdXJyZW50T3BlcmF0aW9uID0gbnVsbDtcblx0XHRsZXQgY3VycmVudE9wZXJhdGlvblJlc3VsdCA9IG51bGw7XG5cdFx0XG5cdFx0bGV0IHN0YW5kQnlPcCA9IG51bGw7XG5cdFx0bGV0IHN0YW5kQnkgPSBmYWxzZTtcblx0XHRsZXQgc3RhbmRCeU51bSA9IG51bGw7XG5cdFx0XG5cdFx0bGV0IGRlY2ltYWxDcmVhdGVkID0gZmFsc2U7XG5cdFx0XG5cdFx0bGV0IGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcblx0XHRtYXRoLmNvbmZpZyh7XG5cdFx0XHRudW1iZXI6ICdCaWdOdW1iZXInLFxuXHRcdFx0cHJlY2lzaW9uOiAyMFxuXHRcdH0pO1xuXHRcdFxuXHRcdFxuXHRcdGlmIChlbXB0eUJvYXJkKSB7XG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgPSBcIjBcIjtcblx0XHRcdFxuXHRcdH1cblx0XHRcblx0XHRsZXQgaXNJbnQgPSBmdW5jdGlvbiAobnVtKSB7XG5cdFx0XHRcblx0XHRcdHJldHVybiBudW0gJSAxID09PSAxO1xuXHRcdFx0XG5cdFx0fTtcblx0XHRcblx0XHRcblx0XHR0aGlzLmFwcGVuZERpZ2l0ID0gZnVuY3Rpb24gKGRpZ2l0KSB7XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogY3VycmVudE51bWJlciA9IFwiXCIgLT4gcHJlcGFyZXMgYm9hcmQgdG8gcmVtb3ZlIHBsYWNlaG9sZGVyIG51bWJlcnNcblx0XHRcdCAqIHdoZW4gYSBuZXcgbnVtYmVyIHNlcXVlbmNlIGlzIGRldGVjdGVkXG5cdFx0XHQgKi9cblx0XHRcdFxuXHRcdFx0XG5cdFx0XHRpZiAoZW1wdHlCb2FyZCkge1xuXHRcdFx0XHRcblx0XHRcdFx0Y3VycmVudE51bWJlciA9IFwiXCI7XG5cdFx0XHRcdGVtcHR5Qm9hcmQgPSBmYWxzZTtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdGlmICghaW5wdXREaXJ0eSkge1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKGRpZ2l0ID09PSAwKSB7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE51bWJlciA9IDA7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHR9IGVsc2UgaWYgKGRpZ2l0ID09PSBcIi5cIiAmJiAhZGVjaW1hbENyZWF0ZWQpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjdXJyZW50TnVtYmVyID0gIFwiMC5cIjtcblx0XHRcdFx0XHRpbnB1dERpcnR5ID0gdHJ1ZTtcblx0XHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IHRydWU7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0XHRjdXJyZW50TnVtYmVyID0gXCJcIjtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdGlmIChkaWdpdCA9PT0gXCIuXCIgJiYgIWRlY2ltYWxDcmVhdGVkKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IHRydWU7XG5cdFx0XHRcdFxuXHRcdFx0fSBlbHNlIGlmIChkaWdpdCA9PT0gXCIuXCIpIHtcblx0XHRcdFx0XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogVGhlIGN1cnJlbnQgbnVtYmVyIGhhcyB0byBiZSBjcmVhdGVkIGFzIGEgc3RyaW5nLCBvciBlbHNlLFxuXHRcdFx0ICogaWYgeW91IGFkZCB0aGUgKC0pIHNpZ24gaW4gdGhlIG1pZGRsZSBvZiBrZXlpbmcgYSBudW1iZXJcblx0XHRcdCAqIHRoZSBudW1iZXIgYWZ0ZXIgdGhlICgtKSB3aWxsIHRyaWdnZXIgYW4gb3BlcmF0aW9uLlxuXHRcdFx0ICovXG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgKz0gZGlnaXQudG9TdHJpbmcoKTtcblx0XHRcdFxuXHRcdFx0aW5wdXREaXJ0eSA9IHRydWU7XG5cdFx0XHRcblx0XHR9O1xuXHRcdFxuXHRcdHRoaXMuZ2V0Q3VycmVudE51bWJlciA9IGZ1bmN0aW9uICgpIHtcblxuXHRcdFx0cmV0dXJuIGN1cnJlbnROdW1iZXI7XG5cblx0XHR9O1xuXHRcdFxuXHRcdGNvbnN0IGV4ZWN1dGVPcGVyYXRpb24gPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcblx0XHRcdGNvbnNvbGUubG9nKGBFeGVjdXRpbmcgJHtjdXJyZW50T3BlcmF0aW9ufWApO1xuXHRcdFx0XG5cdFx0XHRjb25zdCBkaWdpdEEgPSBtYXRoLmJpZ251bWJlcihudW1iZXJTdGFjay5zaGlmdCgpKTtcblx0XHRcdGNvbnN0IGRpZ2l0QiA9IG1hdGguYmlnbnVtYmVyKG51bWJlclN0YWNrLnNoaWZ0KCkpO1xuXHRcdFx0XG5cdFx0XHRzd2l0Y2ggKGN1cnJlbnRPcGVyYXRpb24pIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNhc2UgXCJhZGRpdGlvblwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBtYXRoLmFkZChkaWdpdEEsIGRpZ2l0Qik7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGNhc2UgXCJzdWJ0cmFjdGlvblwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBtYXRoLnN1YnRyYWN0KGRpZ2l0QSwgZGlnaXRCKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSBcIm11bHRpcGxpY2F0aW9uXCI6XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IG1hdGgubXVsdGlwbHkoZGlnaXRBLCBkaWdpdEIpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlIFwiZGl2aXNpb25cIjpcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gbWF0aC5kaXZpZGUoZGlnaXRBLCBkaWdpdEIpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRjYXNlIFwicGVyY2VudGFnZVwiOlxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmIChkaWdpdEIgPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uUmVzdWx0ID0gcGFyc2VGbG9hdChkaWdpdEEgLyAxMDApO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaCgoZGlnaXRBKSk7XG5cdFx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKHBhcnNlRmxvYXQoZGlnaXRBICogcGFyc2VGbG9hdChkaWdpdEIgLyAxMDApKSk7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcblx0XHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhgT3BlcmF0aW9uICR7Y3VycmVudE9wZXJhdGlvbn0gaGFzIG5vdCBiZWVuIGNyZWF0ZWQuYCk7XG5cdFx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdFxuXHRcdFx0aWYgKGlzSW50KGN1cnJlbnRPcGVyYXRpb25SZXN1bHQpKSB7XG5cblx0XHRcdFx0Y29uc29sZS5sb2coYFJlc3VsdCBpcyBhbiBpbnRlZ2VyIWApO1xuXG5cdFx0XHR9IGVsc2Uge1xuXG5cdFx0XHRcdGNvbnNvbGUubG9nKGBSZXN1bHQgaXMgYSBmbG9hdCFgKTtcblxuXHRcdFx0XHRpZiAoY3VycmVudE9wZXJhdGlvblJlc3VsdCkge1xuXG5cdFx0XHRcdFx0Y29uc29sZS5sb2coY3VycmVudE9wZXJhdGlvblJlc3VsdCk7XG5cblx0XHRcdFx0XHRsZXQgZGVjaW1hbENvdW50ZXIgPSAwO1xuXHRcdFx0XHRcdGxldCBkZWNpbWFsU3RyaW5nID0gY3VycmVudE9wZXJhdGlvblJlc3VsdC50b1N0cmluZygpO1xuXHRcdFx0XHRcdGxldCBkb3RQbGFjZSA9IG51bGw7XG5cdFx0XHRcdFx0bGV0IGJlZm9yZURvdCA9IDA7XG5cblx0XHRcdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGRlY2ltYWxTdHJpbmcubGVuZ3RoOyBpKyspIHtcblxuXHRcdFx0XHRcdFx0aWYgKGRlY2ltYWxTdHJpbmdbaV0gPT09IFwiLlwiKSB7XG5cblx0XHRcdFx0XHRcdFx0ZG90UGxhY2UgPSBpO1xuXHRcdFx0XHRcdFx0XHRicmVhaztcblxuXHRcdFx0XHRcdFx0fSBlbHNlIGlmICghaXNOYU4oZGVjaW1hbFN0cmluZ1tpXSkpIHtcblx0XHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRcdGJlZm9yZURvdCsrO1xuXHRcdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZiAoZG90UGxhY2UgIT09IG51bGwpIHtcblxuXHRcdFx0XHRcdFx0Zm9yIChsZXQgaSA9IGRvdFBsYWNlICsgMTsgaSA8IGRlY2ltYWxTdHJpbmcubGVuZ3RoOyBpKyspIHtcblxuXHRcdFx0XHRcdFx0XHRkZWNpbWFsQ291bnRlcisrO1xuXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKGRlY2ltYWxDb3VudGVyID4gMTQgJiYgYmVmb3JlRG90ID09PSAxKSB7XG5cblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb25SZXN1bHQgPSBwYXJzZUZsb2F0KGN1cnJlbnRPcGVyYXRpb25SZXN1bHQpLnRvRml4ZWQoMTQpO1xuXG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdH1cblxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRjb25zb2xlLmxvZyhgUmVzdWx0OiAke2N1cnJlbnRPcGVyYXRpb25SZXN1bHR9YCk7XG5cdFx0XHRcblx0XHRcdGN1cnJlbnROdW1iZXIgPSBjdXJyZW50T3BlcmF0aW9uUmVzdWx0O1xuXHRcdFx0XG5cdFx0fTtcblx0XHRcblx0XHRcblx0XHR0aGlzLnNldEN1cnJlbnRPcGVyYXRpb24gPSBmdW5jdGlvbiAob3ApIHtcblx0XHRcdFxuXHRcdFx0aWYgKG9wID09PSBcInJlc3VsdGFudFwiKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAoc3RhbmRCeSkge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goY3VycmVudE51bWJlcik7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0ZXhlY3V0ZU9wZXJhdGlvbigpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goY3VycmVudE51bWJlcik7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0bnVtYmVyU3RhY2sudW5zaGlmdChzdGFuZEJ5TnVtKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uID0gc3RhbmRCeU9wO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdHN0YW5kQnkgPSBmYWxzZTtcblx0XHRcdFx0XHRcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdFx0aWYgKG51bWJlclN0YWNrID09PSAyKSB7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0ZXhlY3V0ZU9wZXJhdGlvbigpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goY3VycmVudE51bWJlcik7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y29uc29sZS5sb2cobnVtYmVyU3RhY2spO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcdFx0XHRcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0LyoqXG5cdFx0XHQgKiBJZiB0aGVyZSBpcyBub3RoaW5nIGluIG51bWJlclN0YWNrICYgdGhlcmUgaXMgbm8gaW5wdXQsIGRvIG5vdGhpbmdcblx0XHRcdCAqIElmIHRoZXJlIGlzIG5vdGhpbmcgaW4gbnVtYmVyU3RhY2sgJiB0aGVyZSBpcyBpbnB1dCwgZGVmaW5lIGFuIG9wZXJhdGlvblxuXHRcdFx0ICovXG5cdFx0XHRcblx0XHRcdGlmIChudW1iZXJTdGFjay5sZW5ndGggPT09IDAgJiYgIWlucHV0RGlydHkpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKFwiVGhlcmUgaXMgbm90aGluZyB0byBvcGVyYXRlIG9uXCIpO1xuXHRcdFx0XHRcblx0XHRcdH0gZWxzZSBpZiAobnVtYmVyU3RhY2subGVuZ3RoID09PSAwICYmIGlucHV0RGlydHkpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKFwiVGhlcmUgaXMgc29tZXRoaW5nIHRvIHB1dCBpbiB0aGUgc3RhY2shXCIpO1xuXHRcdFx0XHRcblx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9wO1xuXHRcdFx0XHRcblx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChjdXJyZW50TnVtYmVyKTtcblx0XHRcdFx0Y29uc29sZS5sb2cobnVtYmVyU3RhY2spO1xuXHRcdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cdFx0XHRcdGRlY2ltYWxDcmVhdGVkID0gZmFsc2U7XG5cdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHQvKiogSWYgdGhlcmUgaXMgb25lIGVsZW1lbnQgaW4gbnVtYmVyU3RhY2sgJiB0aGVyZSBpcyBubyBpbnB1dCxcblx0XHRcdCAqIGRlZmluZSBhbiBvcGVyYXRpb24gb3IgYWxsb3cgdG8gc3dpdGNoIG9wZXJhdGlvbnNcblx0XHRcdCAqIElmIHRoZXJlIGlzIG9uZSBlbGVtZW50IGluIG51bWJlclN0YWNrICYgdGhlcmUgaXMgaW5wdXQsXG5cdFx0XHQgKiBwdXNoIHRoZSBpbnB1dCBpbnRvIG51bWJlclN0YWNrXG5cdFx0XHQgKi9cblx0XHRcdFxuXHRcdFx0aWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMSAmJiAhaW5wdXREaXJ0eSkge1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc29sZS5sb2coXCJUaGVyZSBpcyBhbiBlbGVtZW50IGluIHRoZSBzdGFja1wiKTtcblx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9wO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhjdXJyZW50T3BlcmF0aW9uKTtcblx0XHRcdFx0XG5cdFx0XHRcdGlmIChvcCA9PT0gXCJwZXJjZW50YWdlXCIpIHtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChjdXJyZW50TnVtYmVyKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdH0gZWxzZSBpZiAobnVtYmVyU3RhY2subGVuZ3RoID09PSAxICYmIGlucHV0RGlydHkpIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKGBUaGVyZSBpcyBhbiBlbGVtZW50IGluIHRoZSBzdGFjayAmIGEgbmV3IG51bWJlciBoYXMgYmVlbiBlbnRlcmVkYCk7XG5cdFx0XHRcdFxuXHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKGN1cnJlbnROdW1iZXIpO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhudW1iZXJTdGFjayk7XG5cdFx0XHRcdGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcdFx0ZGVjaW1hbENyZWF0ZWQgPSBmYWxzZTtcblx0XHRcdFx0XG5cdFx0XHRcdC8qKlxuXHRcdFx0XHQgKiBUaGlzIHdpbGwgbWFrZSB0aGUgZXhlY3V0aW9uIGJsb2NrIHRvIHJ1bi5cblx0XHRcdFx0ICogVGhlIG9wZXJhdGlvbiB0aGF0IHdhcyBhc3NpZ25lZCB0byB0cmlnZ2VyIHRoZSBleGVjdXRpb25cblx0XHRcdFx0ICogd2lsbCBiZSBzdG9yZWQgYWZ0ZXIgdGhlIGV4ZWN1dGlvbiBpcyBkb25lIGFzIGl0IHdpbGxcblx0XHRcdFx0ICogbGVhdmUgb25lIGVsZW1lbnQgaW4gdGhlIHN0YWNrIHJlYWR5IHRvIGFuIG9wZXJhdGlvblxuXHRcdFx0XHQgKi9cblx0XHRcdFx0XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogSWYgdGhlcmUgYXJlIHR3byBlbGVtZW50cyBpbiBudW1iZXJTdGFjayxcblx0XHRcdCAqIGV4ZWN1dGUgdGhlIGN1cnJlbnQgb3BlcmF0aW9uXG5cdFx0XHQgKi9cblx0XHRcdFxuXHRcdFx0aWYgKG51bWJlclN0YWNrLmxlbmd0aCA9PT0gMikge1xuXHRcdFx0XHRcblx0XHRcdFx0Y29uc29sZS5sb2coXCJFeGVjdXRlIE9wZXJhdGlvblwiKTtcblx0XHRcdFx0XG5cdFx0XHRcdC8qKlxuXHRcdFx0XHQgKiBUaGUgY3VycmVudCBvcGVyYXRpb24gY291bGQgY2hhbmdlIHByaW9yIHRvIGNvbXB1dGF0aW9uXG5cdFx0XHRcdCAqIHdoZW4gdXNpbmcgdGhlIHBlcmNlbnRhZ2Ugb3BlcmF0b3IgKCUpIGFzIGEgYmluYXJ5IG9wZXJhdG9yXG5cdFx0XHRcdCAqL1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKG9wID09PSBcInBlcmNlbnRhZ2VcIikge1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGxldCBvbmdvaW5nT3AgPSBjdXJyZW50T3BlcmF0aW9uO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9uZ29pbmdPcDtcblx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChjdXJyZW50TnVtYmVyKTtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHRcdGlmIChjdXJyZW50T3BlcmF0aW9uID09PSBcImFkZGl0aW9uXCIgfHwgY3VycmVudE9wZXJhdGlvbiA9PT0gXCJzdWJ0cmFjdGlvblwiKSB7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0aWYgKG9wID09PSBcIm11bHRpcGxpY2F0aW9uXCIgfHwgb3AgPT09IFwiZGl2aXNpb25cIikge1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRzdGFuZEJ5ID0gdHJ1ZTtcblx0XHRcdFx0XHRcdHN0YW5kQnlPcCA9IGN1cnJlbnRPcGVyYXRpb247XG5cdFx0XHRcdFx0XHRzdGFuZEJ5TnVtID0gbnVtYmVyU3RhY2suc2hpZnQoKTtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0Y3VycmVudE9wZXJhdGlvbiA9IG9wO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IGZhbHNlO1xuXHRcdFx0XHRcdFx0aW5wdXREaXJ0eSA9IGZhbHNlO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XG5cdFx0XHRcdH1cblx0XHRcdFx0XG5cdFx0XHRcdGlmIChjdXJyZW50T3BlcmF0aW9uID09PSBcIm11bHRpcGxpY2F0aW9uXCIgfHwgY3VycmVudE9wZXJhdGlvbiA9PT0gXCJkaXZpc2lvblwiKSB7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0aWYgKChvcCA9PT0gXCJhZGRpdGlvblwiIHx8IG9wID09PSBcInN1YnRyYWN0aW9uXCIpICYmIHN0YW5kQnkpIHtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0ZXhlY3V0ZU9wZXJhdGlvbigpO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRudW1iZXJTdGFjay5wdXNoKGN1cnJlbnROdW1iZXIpO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRudW1iZXJTdGFjay51bnNoaWZ0KHN0YW5kQnlOdW0pO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjdXJyZW50T3BlcmF0aW9uID0gc3RhbmRCeU9wO1xuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRleGVjdXRlT3BlcmF0aW9uKCk7XG5cblx0XHRcdFx0XHRcdG51bWJlclN0YWNrLnB1c2goY3VycmVudE51bWJlcik7XG5cdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRzdGFuZEJ5ID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRzdGFuZEJ5T3AgPSBudWxsO1xuXHRcdFx0XHRcdFx0c3RhbmRCeU51bSA9IG51bGw7XG5cblx0XHRcdFx0XHRcdGRlY2ltYWxDcmVhdGVkID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHRcdFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcblx0XHRcdFx0fVxuXHRcdFx0XHRcblx0XHRcdFx0XG5cdFx0XHRcdGV4ZWN1dGVPcGVyYXRpb24oKTtcblx0XHRcdFx0XG5cdFx0XHRcdC8vIE9wZXJhdGlvbiBpcyBjb21wbGV0ZS4gQWRkIHJlc3VsdCB0byBudW1iZXJTdGFja1xuXHRcdFx0XHRcblx0XHRcdFx0bnVtYmVyU3RhY2sucHVzaChjdXJyZW50TnVtYmVyKTtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKG51bWJlclN0YWNrKTtcblx0XHRcdFx0XG5cdFx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBvcDtcblx0XHRcdFx0Y29uc29sZS5sb2coY3VycmVudE9wZXJhdGlvbik7XG5cdFx0XHRcdFxuXHRcdFx0XHRkZWNpbWFsQ3JlYXRlZCA9IGZhbHNlO1xuXHRcdFx0XHRpbnB1dERpcnR5ID0gZmFsc2U7XG5cdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0fTtcblx0XHRcblx0XHR0aGlzLmNsZWFyQm9hcmQgPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcblx0XHRcdGNvbnNvbGUubG9nKFwiQ0xFQVJcIik7XG5cdFx0XHRcblx0XHRcdGVtcHR5Qm9hcmQgPSB0cnVlO1xuXHRcdFx0XG5cdFx0XHRudW1iZXJTdGFjay5sZW5ndGggPSAwO1xuXHRcdFx0XG5cdFx0XHRjdXJyZW50TnVtYmVyID0gMDtcblx0XHRcdGN1cnJlbnRPcGVyYXRpb24gPSBudWxsO1xuXHRcdFx0Y3VycmVudE9wZXJhdGlvblJlc3VsdCA9IG51bGw7XG5cdFx0XHRcblx0XHRcdGRlY2ltYWxDcmVhdGVkID0gZmFsc2U7XG5cdFx0XHRcblx0XHRcdGlucHV0RGlydHkgPSBmYWxzZTtcblx0XHRcdFxuXHRcdH07XG5cdFx0XG5cdFx0dGhpcy5mbGlwU2lnbiA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdFxuXHRcdFx0Y29uc29sZS5sb2coXCJmbGlwU2lnblwiKTtcblx0XHRcdFxuXHRcdFx0aWYgKGN1cnJlbnROdW1iZXIgPT0gMCB8fCBlbXB0eUJvYXJkKSB7XG5cdFx0XHRcdFxuXHRcdFx0XHQvKipcblx0XHRcdFx0ICogQXZvaWQgTmFOXG5cdFx0XHRcdCAqL1xuXHRcdFx0XHRcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0XG5cdFx0XHRpZiAobnVtYmVyU3RhY2subGVuZ3RoID09PSAxICYmICFpbnB1dERpcnR5KSB7XG5cdFx0XHRcdFxuXHRcdFx0XHRsZXQgdGVtcE51bSA9IG51bWJlclN0YWNrLnBvcCgpO1xuXHRcdFx0XHRcblx0XHRcdFx0Y3VycmVudE51bWJlciA9IHRlbXBOdW0gKiAtMTtcblx0XHRcdFx0XG5cdFx0XHRcdG51bWJlclN0YWNrLnB1c2goY3VycmVudE51bWJlcik7XG5cdFx0XHRcdFxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XG5cdFx0XHRcdGNvbnNvbGUubG9nKG51bWJlclN0YWNrKTtcblx0XHRcdFx0XG5cdFx0XHRcdGN1cnJlbnROdW1iZXIgPSBjdXJyZW50TnVtYmVyICogLTE7XG5cdFx0XHRcdFxuXHRcdFx0fVxuXHRcdFx0XG5cdFx0fVxuXHRcdFxuXHR9KTtcbiJdfQ==
